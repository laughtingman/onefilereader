<!DOCTYPE html>
<html lang="ru">
<!--
	License MIT - https://opensource.org/licenses/MIT
	Copyright (c) 2021 Talleyran, me@talleyran.ru
-->

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>FB2 reader</title>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.9/vue.min.js' integrity='sha512-deBbW1lpMT6h3gvOzmeMPft4pf9CMGjCKc5jSNq2pMSjtkMPuELbd4N3LKXVq/t1t6qco4q3u/XguyqGqlOMjA==' crossorigin='anonymous'></script>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/jszip/3.5.0/jszip.min.js' integrity='sha512-y3o0Z5TJF1UsKjs/jS2CDkeHN538bWsftxO9nctODL5W40nyXIbs0Pgyu7//icrQY9m6475gLaVr39i/uh/nLA==' crossorigin='anonymous'></script>
	<link rel="shortcut icon" href="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='utf-8'%3F%3E%3Csvg version='1.1' id='icon' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' viewBox='0 0 296.999 296.999' style='enable-background:new 0 0 296.999 296.999;' xml:space='preserve'%3E%3Cg%3E%3Cg%3E%3Cg%3E%3Cpath d='M45.432,35.049c-0.008,0-0.017,0-0.025,0c-2.809,0-5.451,1.095-7.446,3.085c-2.017,2.012-3.128,4.691-3.128,7.543 v159.365c0,5.844,4.773,10.61,10.641,10.625c24.738,0.059,66.184,5.215,94.776,35.136V84.023c0-1.981-0.506-3.842-1.461-5.382 C115.322,40.849,70.226,35.107,45.432,35.049z'/%3E%3Cpath d='M262.167,205.042V45.676c0-2.852-1.111-5.531-3.128-7.543c-1.995-1.99-4.639-3.085-7.445-3.085c-0.009,0-0.018,0-0.026,0 c-24.793,0.059-69.889,5.801-93.357,43.593c-0.955,1.54-1.46,3.401-1.46,5.382v166.779 c28.592-29.921,70.038-35.077,94.776-35.136C257.394,215.651,262.167,210.885,262.167,205.042z'/%3E%3Cpath d='M286.373,71.801h-7.706v133.241c0,14.921-12.157,27.088-27.101,27.125c-20.983,0.05-55.581,4.153-80.084,27.344 c42.378-10.376,87.052-3.631,112.512,2.171c3.179,0.724,6.464-0.024,9.011-2.054c2.538-2.025,3.994-5.052,3.994-8.301V82.427 C297,76.568,292.232,71.801,286.373,71.801z'/%3E%3Cpath d='M18.332,205.042V71.801h-7.706C4.768,71.801,0,76.568,0,82.427v168.897c0,3.25,1.456,6.276,3.994,8.301 c2.545,2.029,5.827,2.78,9.011,2.054c25.46-5.803,70.135-12.547,112.511-2.171c-24.502-23.19-59.1-27.292-80.083-27.342 C30.49,232.13,18.332,219.963,18.332,205.042z'/%3E%3C/g%3E%3C/g%3E%3C/g%3E%3C/svg%3E%0A" type="image/svg+xml">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,700;1,400&family=Roboto:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
	<style>
		.panel,
		.tab,
		.group,
		.scroll {
			box-sizing: border-box;
		}

		.panel {
			position: fixed;
			top: 0;
			left: -16rem;
			font-family: Verdana, Geneva, Tahoma, sans-serif;
			background-color: #fafafa;
			height: 100vh;
			width: 16rem;
			font-size: 1rem;
			transition-property: left;
			transition-duration: 0.5s;
			display: flex;
			flex-direction: column;
			border-right: 1px solid #ccc;
			z-index: 50;
		}

		.panel .tab {
			display: flex;
			flex-direction: column;
			position: relative;
			height: 100%;
			overflow: hidden;
			padding-top: 1rem;
		}

		.panel .scroll {
			overflow-y: auto;
			overflow-x: hidden;
			width: 100%;
			height: 100%;
		}

		.panel .empty {
			color: gray;
			padding: 0.5rem;
			text-align: center;
			display: none;
		}

		.chapters:empty + .empty {
			display: block;
		}

		.bookmarks:empty + .empty {
			display: block;
		}

		.panel:after {
			content: "";
			display: block;
			position: absolute;
			top: 0;
			left: 100%;
			height: 100%;
			width: 2rem;
			text-align: center;
		}

		.panel:hover,
		.panel.active {
			left: 0;
		}

		.panel:hover+.hello,
		.panel.active+.hello {
			display: none;
		}

		.panel .group {
			padding: 0.5rem;
			color: black;
		}

		.panel label {
			display: flex;
			color: black;
			align-items: center;
		}

		.panel label+label {
			margin-top: 0.3rem;
		}

		.panel label span {
			width: 100%;
			display: block;
			margin-right: 0.2rem;
		}

		.panel button,
		.panel select,
		.panel input {
			font-size: 1rem;
			width: 100%;
			height: 1.5rem;
			outline: none;
			box-sizing: border-box;
		}

		body {
			font-size: 16px;
			margin: 0;
			padding: 0;
			overflow-x: hidden;
		}

		.book {
			min-height: 100vh;
		}

		.page {
			max-width: 40em;
			margin: 0 auto;
			padding-top: 2em;
			padding-right: 2rem;
			padding-left: 0.5rem;
			transition-duration: 0.5s;
			transition-property: padding;
		}

		.page.left {
			padding-left: 16.5rem;
		}

		.body {
			padding: 0.2em;
		}

		p {
			font-size: 1em;
			line-height: 1.5em;
			margin: 1em 0;
		}

		img {
			display: block;
			margin: 0 auto;
			max-width: 100%;
			height: auto;
		}

		figure {
			display: block;
			margin: 1em auto;
			width: max-content;
			max-width: 100%;
		}

		figure.png {
			background-color: white;
		}

		.title {
			font-weight: bold;
			margin: 2em 0 1rem 0;
			text-rendering: optimizeLegibility;
			font-kerning: normal;
		}

		.title p {
			font-size: 2em;
			text-indent: 0;
			text-align: left;
		}

		.title p+p {
			font-size: 1.5em;
		}

		.subtitle {
			text-align: center;
		}

		.epigraph {
			max-width: 60%;
			margin-left: auto;
		}

		blockquote {
			border-left: 0.4em solid black;
			padding-left: 1em;
			margin: 1em 0;
		}

		.scroll::-webkit-scrollbar {
			width: 0.4rem;
		}

		.scroll::-webkit-scrollbar-track {
			background: #eee;
		}

		.scroll::-webkit-scrollbar-thumb {
			background-color: #ccc;
			border-radius: 20px;
		}

		body::-webkit-scrollbar,
		.notes .scroll::-webkit-scrollbar {
			width: 0.4rem;
		}

		body::-webkit-scrollbar-thumb,
		.notes .scroll::-webkit-scrollbar-thumb {
			border-radius: 20px;
		}

		.notes {
			position: fixed;
			max-width: 42em;
			height: 30vh;
			left: 0;
			right: 0;
			bottom: -31vh;
			margin: 0 auto;
			transition-property: bottom left;
			transition-duration: 0.5s;
		}

		.notes .scroll {
			height: 100%;
			overflow-y: scroll;
		}

		.notes.show {
			bottom: 0;
		}

		.notes .title {
			margin: 1em 0;
		}

		.notes p {
			font-size: 0.8em;
			text-indent: 0;
		}

		.notes .title p {
			font-size: 1em;
		}

		.notes .close {
			border: 0;
			background-color: transparent;
			outline: none;
			color: currentColor;
			position: absolute;
			right: 0.4rem;
			top: 0;
			width: 2rem;
			cursor: pointer;
			font-size: 2rem;
			z-index: 100;
		}

		.notes .body {
			padding-right: 0.2em;
		}

		.notes.left {
			left: 16.5rem;
		}

		.panel .statusbar {
			background: rgba(0, 0, 0, 0.1);
		}

		.panel .statusbar .value {
			background: rgba(0, 0, 0, 0.1);
		}

		.panel .tabs {
			display: flex;
			background-color: #dbdbdb;
		}

		.panel .tabs input {
			display: none;
		}

		.panel .tabs label {
			padding: 0.5rem;
			margin: 0;
			width: 100%;
			justify-content: center;
			border-left: 1px solid transparent;
			border-right: 1px solid transparent;
		}

		.panel .tabs input:checked+label {
			background-color: white;
		}

		.panel .tabs input:checked+label:not(:last-of-type) {
			border-right-color: #ccc;
		}

		.panel .tabs input:checked+label:not(:first-of-type) {
			border-left-color: #ccc;
		}

		.panel .tabs label.pin {
			width: 1rem;
			color: rgba(1, 1, 1, .2);
			border-left-color: transparent !important;
		}

		.panel .tabs input:checked+label.pin {
			background-color: transparent !important;
			color: rgba(0, 170, 255);
		}

		.panel .chapters,
		.panel .bookmarks {
			padding: 0;
			margin: 0;
		}

		.panel .chapter,
		.panel .bookmark {
			list-style: none;
			display: flex;
			cursor: pointer;
			color: black;
			user-select: none;
			padding: 0.3rem 0.5rem;
		}

		.panel .bookmark {
			justify-content: space-between;
		}

		.panel .bookmark span:empty {
			display: none;
		}

		.panel.bookmark span+span {
			margin-left: 1rem;
		}

		.panel .chapter:empty {
			display: none;
		}

		.panel .chapter:hover,
		.panel .bookmark:hover,
		.chapter.active {
			background-color: rgba(0, 0, 0, .1);
		}

		.panel .chapter.active {
			text-shadow: 0 0 1px black;
		}

		.icon {
			display: inline-block;
			width: 1em;
			height: 1em;
			stroke-width: 0;
			stroke: currentColor;
			fill: currentColor;
		}

		.panel img {
			width: 100%;
		}

		.panel p {
			text-indent: 0;
		}

		.loading {
			font-size: 1em;
			font-family: Verdana, Geneva, Tahoma, sans-serif;
			transition-property: left;
			transition-duration: 0.5s;
			position: fixed;
			top: 0;
			left: 0;
			bottom: 0;
			right: 0;
			margin: auto;
			width: 100%;
			text-align: center;
			padding-top: 5rem;
			height: 100vh;
			display: flex;
			background-color: inherit;
			justify-content: center;
			color: inherit;
			z-index: 1;
		}

		.loading svg {
			animation: rotation 2s infinite linear;
			margin-right: 1rem;
		}

		@keyframes rotation {
			from {
				-webkit-transform: rotate(0deg);
			}

			to {
				-webkit-transform: rotate(359deg);
			}
		}

		.hello {
			padding: 1rem;
			font-size: 1rem;
		}

		p.mark {
			position: relative;
		}

		p.mark:before {
			position: sticky;
			float: right;
			content: "";
			border: 12px solid currentColor;
			border-bottom-color: transparent;
			height: 0.5rem;
			margin-right: -2rem;
			margin-bottom: -0.5rem;
			top:0.5rem;
			left: 100%;
			opacity: 0;
			transition-property: opacity;
			transition-duration: 0.5s;
		}

		p.mark.checked:before {
			opacity: 1;
		}

		a {
			text-decoration: none;
		}

		.annotation {
			font-size: 0.75rem;
		}

		figure.float {
			display: inline;
		}

		figure.float img {
			display: inline;
			margin: 0;
		}

		p.dialogue+p.dialogue {
				margin-top:-1em;
		}
	</style>
</head>

<body>

	<svg style="display: none;">
		<symbol id="icon-settings" viewBox="0 0 32 32">
			<path d="M29.181 19.070c-1.679-2.908-0.669-6.634 2.255-8.328l-3.145-5.447c-0.898 0.527-1.943 0.829-3.058 0.829-3.361 0-6.085-2.742-6.085-6.125h-6.289c0.008 1.044-0.252 2.103-0.811 3.070-1.679 2.908-5.411 3.897-8.339 2.211l-3.144 5.447c0.905 0.515 1.689 1.268 2.246 2.234 1.676 2.903 0.672 6.623-2.241 8.319l3.145 5.447c0.895-0.522 1.935-0.82 3.044-0.82 3.35 0 6.067 2.725 6.084 6.092h6.289c-0.003-1.034 0.259-2.080 0.811-3.038 1.676-2.903 5.399-3.894 8.325-2.219l3.145-5.447c-0.899-0.515-1.678-1.266-2.232-2.226zM16 22.479c-3.578 0-6.479-2.901-6.479-6.479s2.901-6.479 6.479-6.479c3.578 0 6.479 2.901 6.479 6.479s-2.901 6.479-6.479 6.479z"></path>
		</symbol>
		<symbol id="icon-book" viewBox="0 0 32 32">
			<path d="M28 4v26h-21c-1.657 0-3-1.343-3-3s1.343-3 3-3h19v-24h-20c-2.2 0-4 1.8-4 4v24c0 2.2 1.8 4 4 4h24v-28h-2z"></path>
			<path d="M7.002 26v0c-0.001 0-0.001 0-0.002 0-0.552 0-1 0.448-1 1s0.448 1 1 1c0.001 0 0.001-0 0.002-0v0h18.997v-2h-18.997z"></path>
		</symbol>
		<symbol id="icon-list" viewBox="0 0 32 32">
			<path d="M0 0h8v8h-8zM12 2h20v4h-20zM0 12h8v8h-8zM12 14h20v4h-20zM0 24h8v8h-8zM12 26h20v4h-20z"></path>
		</symbol>
		<symbol id="icon-pin" viewBox="0 0 20 20">
			<path d="M11 12h6v-1l-3-1v-8l3-1v-1h-14v1l3 1v8l-3 1v1h6v7l1 1 1-1v-7z"></path>
		</symbol>
		<symbol id="icon-spinner" viewBox="0 0 32 32">
			<path d="M32 16c-0.040-2.089-0.493-4.172-1.331-6.077-0.834-1.906-2.046-3.633-3.533-5.060-1.486-1.428-3.248-2.557-5.156-3.302-1.906-0.748-3.956-1.105-5.981-1.061-2.025 0.040-4.042 0.48-5.885 1.292-1.845 0.809-3.517 1.983-4.898 3.424s-2.474 3.147-3.193 4.994c-0.722 1.846-1.067 3.829-1.023 5.79 0.040 1.961 0.468 3.911 1.254 5.694 0.784 1.784 1.921 3.401 3.316 4.736 1.394 1.336 3.046 2.391 4.832 3.085 1.785 0.697 3.701 1.028 5.598 0.985 1.897-0.040 3.78-0.455 5.502-1.216 1.723-0.759 3.285-1.859 4.574-3.208 1.29-1.348 2.308-2.945 2.977-4.67 0.407-1.046 0.684-2.137 0.829-3.244 0.039 0.002 0.078 0.004 0.118 0.004 1.105 0 2-0.895 2-2 0-0.056-0.003-0.112-0.007-0.167h0.007zM28.822 21.311c-0.733 1.663-1.796 3.169-3.099 4.412s-2.844 2.225-4.508 2.868c-1.663 0.646-3.447 0.952-5.215 0.909-1.769-0.041-3.519-0.429-5.119-1.14-1.602-0.708-3.053-1.734-4.25-2.991s-2.141-2.743-2.76-4.346c-0.621-1.603-0.913-3.319-0.871-5.024 0.041-1.705 0.417-3.388 1.102-4.928 0.683-1.541 1.672-2.937 2.883-4.088s2.642-2.058 4.184-2.652c1.542-0.596 3.192-0.875 4.832-0.833 1.641 0.041 3.257 0.404 4.736 1.064 1.48 0.658 2.82 1.609 3.926 2.774s1.975 2.54 2.543 4.021c0.57 1.481 0.837 3.064 0.794 4.641h0.007c-0.005 0.055-0.007 0.11-0.007 0.167 0 1.032 0.781 1.88 1.784 1.988-0.195 1.088-0.517 2.151-0.962 3.156z"></path>
		</symbol>
		<symbol id="icon-bookmark" viewBox="0 0 24 24">
			<path d="M17.016 3q0.797 0 1.383 0.609t0.586 1.406v15.984l-6.984-3-6.984 3v-15.984q0-0.797 0.586-1.406t1.383-0.609h10.031z"></path>
		</symbol>
	</svg>

	<div id="app">
		<div class="book" :style="style">
			<div class="panel" :class="{active:options.pin}">

				<div class="tabs">
					<input type="radio" value="1" v-model.number="options.tab" id="tab1"><label for="tab1"><svg class="icon">
							<use xlink:href="#icon-book"></use>
						</svg></label>
					<input type="radio" value="2" v-model.number="options.tab" id="tab2"><label for="tab2"><svg class="icon">
							<use xlink:href="#icon-list"></use>
						</svg></label>
					<input type="radio" value="3" v-model.number="options.tab" id="tab3"><label for="tab3"><svg class="icon">
							<use xlink:href="#icon-bookmark"></use>
						</svg></label>
					<input type="radio" value="4" v-model.number="options.tab" id="tab4"><label for="tab4"><svg class="icon">
							<use xlink:href="#icon-settings"></use>
						</svg></label>
					<input type="checkbox" v-model="options.pin" id="pin"><label class="pin" for="pin"><svg class="icon icon-pin">
							<use xlink:href="#icon-pin"></use>
						</svg></label>
				</div>
				<div v-show="options.tab==1" class="tab">
					<div class="group">
						<button class="btn" @click="open">{{lang("open")}}</button>
					</div>
					<div class="scroll">
						<div class="group">
							<img :src="book.cover">
							<div class="statusbar">
								<div class="value" :style="{width:percent + '%'}">{{percent}}%</div>
							</div>
						</div>
						<div class="group">
							<div>{{book.author}}</div>
							<div><b>{{book.title}}</b></div>
							<div><i>{{book.sequence}}</i></div>
						</div>
						<div class="group">
							<div v-html="book.annotation"></div>
						</div>
					</div>
				</div>
				<div v-show="options.tab==2" class="tab">
					<div class="scroll">
						<ul class="chapters">
							<li class="chapter" v-for="(chapter,i) in book.chapters" :class="{active:i==currentChapter}" @click="goChapter(i)" v-if="chapter.deep>-1 && chapter.title!=''">
								<span :style="{minWidth:chapter.deep + 'rem'}"></span>
								<span>{{chapter.title}}</span>
							</li>
						</ul>
						<div class="empty">{{lang("notitle")}}</div>
					</div>
				</div>
				<div v-show="options.tab==3" class="tab">
					<div class="scroll">
						<ul class="bookmarks">
							<li class="bookmark" v-for="bookmark in bookmarks" @click="goBookmark(bookmark.number)">
								<span>{{bookmark.title}}</span>
								<span>&sect;&nbsp;{{bookmark.number}}</span>
							</li>
						</ul>
						<div class="empty">{{lang("nobookmarks")}}</div>
					</div>
				</div>
				<div v-show="options.tab==4" class="tab">
					<div class="scroll">
						<div class="group">
							<label><span>{{lang("theme")}}:</span>
								<select @change="theme" v-model="options.theme" :style="{color:options.color,backgroundColor:options.background}">
									<option value="#000000/#FFFFFF/#00AAFF" style="color:#000000;background:#FFFFFF">Black on white</option>
									<option value="#111111/#FFFad6/#AD6410" style="color:#111111;background:#FFFad6">Grey on yellow</option>
									<option value="#CCCCCC/#000000/#00AAFF" style="color:#CCCCCC;background:#000000">Grey on black</option>
									<option value="#5bae67/#000000/#8cae5b" style="color:#5bae67;background:#000000">Green on black</option>
									<option value="custom">Custom</option>
								</select>
							</label>
						</div>
						<div class="group" v-if="options.theme=='custom'">
							<label><span>{{lang("text")}}:</span><input type="color" v-model="options.color"></label>
							<label><span>{{lang("background")}}:</span><input type="color" v-model="options.background"></label>
							<label><span>{{lang("links")}}:</span><input type="color" v-model="options.links"></label>
						</div>
						<div class="group">
							<label><span>{{lang("imgbg")}}:</span>
								<select v-model="options.figure">
									<option value="transparent">Transparent</option>
									<option value="white">White</option>
								</select>
							</label>
						</div>
						<div class="group">
							<label><span>{{lang("font")}}:</span>
								<select v-model="options.fontFamily" :style="{fontFamily:options.fontFamily}" @change="sizeChanged">
									<option value="Roboto,sans-serif" style="font-family: Roboto,sans-serif">Roboto</option>
									<option value="Verdana,sans-serif" style="font-family: Verdana,sans-serif">Verdana</option>
									<option value="Helvetica,sans-serif" style="font-family: Helvetica,sans-serif">Helvetica</option>
									<option value="Georgia,serif" style="font-family: Georgia,serif">Georgia</option>
									<option value="'Times New Roman',serif" style="font-family:'Times New Roman',serif">Times New Roman</option>
									<option value="'EB Garamond',serif" style="font-family:'EB Garamond',serif">Garamond</option>
								</select>
							</label>
							<label><span>{{lang("size")}}:</span>
								<select v-model.number="options.fontSize" @change="sizeChanged">
									<option value="12">12</option>
									<option value="14">14</option>
									<option value="16">16</option>
									<option value="18">18</option>
									<option value="20">20</option>
									<option value="22">22</option>
									<option value="24">24</option>
								</select>
							</label>
						</div>
					</div>
				</div>

			</div>
			<div class="hello" v-if="book.main==''"><svg class="icon">
					<use xlink:href="#icon-book"></use>
				</svg></div>
			<div class="loading" v-if="loading" :class="{left:options.pin}"><svg class="icon icon-spinner">
					<use xlink:href="#icon-spinner"></use>
				</svg> {{lang('loading')}}</div>
			<div v-html="book.main" class="page" :class="{left:options.pin}"></div>
			<div class="notes" :class="{'show':showNotes,'left':options.pin}">
				<button class="close" @click="hideNotes">&times;</button>
				<div v-html="book.notes" class="scroll"></div>
			</div>
			<div v-html="moreStyles"></div>
		</div>
	</div>

	<script>
		const SimpleIDB = {

			dbName: "myDatabase",
			storeName: "myStore",

			initialize() {
				let that = this;
				window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;

				return new Promise((resolve, reject) => {
					let request = indexedDB.open(that.dbName);
					request.onupgradeneeded = function() {
						request.result.createObjectStore(that.storeName);
						resolve();
					}
					request.onerror = function() {
						reject(request.error);
					}
				});
			},

			get(key) {
				let that = this;
				return new Promise((resolve, reject) => {
					let oRequest = indexedDB.open(that.dbName);
					oRequest.onsuccess = function() {
						let db = oRequest.result
						let tx = db.transaction(that.storeName, 'readonly');
						let st = tx.objectStore(that.storeName)
						let gRequest = st.get(key);
						gRequest.onsuccess = function() {
							resolve(gRequest.result);
						}
						gRequest.onerror = function() {
							reject(gRequest.error);
						}
					}
					oRequest.onerror = function() {
						reject(oRequest.error);
					}
				});
			},

			set(key, value) {
				let that = this;
				return new Promise((resolve, reject) => {
					let oRequest = indexedDB.open(that.dbName);
					oRequest.onsuccess = function() {
						let db = oRequest.result
						let tx = db.transaction(that.storeName, 'readwrite')
						let st = tx.objectStore(that.storeName)
						let sRequest = st.put(value, key)
						sRequest.onsuccess = function() {
							resolve();
						}
						sRequest.onerror = function() {
							reject(sRequest.error);
						}
					}
					oRequest.onerror = function() {
						reject(oRequest.error);
					}
				});
			},

			remove(key) {
				let that = this;
				return new Promise((resolve, reject) => {
					let oRequest = indexedDB.open(that.dbName);
					oRequest.onsuccess = function() {
						let db = oRequest.result
						let tx = db.transaction(that.storeName, 'readwrite');
						let st = tx.objectStore(that.storeName);
						let rRequest = st.delete(key);
						rRequest.onsuccess = function() {
							resolve();
						}
						rRequest.onerror = function() {
							reject(rRequest.error);
						}
					}
					oRequest.onerror = function() {
						reject(oRequest.error);
					}
				});
			}
		};

		const translations = [{
				id: "text",
				"ru": "Текст",
				"en": "Text"
			},
			{
				id: "background",
				"ru": "Фон",
				"en": "Background"
			},
			{
				id: "links",
				"ru": "Ссылки",
				"en": "links"
			},
			{
				id: "font",
				"ru": "Шрифт",
				"en": "Font"
			},
			{
				id: "text",
				"ru": "Текст",
				"en": "Text"
			},
			{
				id: "theme",
				"ru": "Тема",
				"en": "Theme"
			},
			{
				id: "open",
				"ru": "Открыть fb2",
				"en": "Open fb2"
			},
			{
				id: "size",
				"ru": "Размер",
				"en": "Font size"
			},
			{
				id: "imgbg",
				"ru": "Фон картинок",
				"en": "Picture background"
			},
			{
				id: "not_supported",
				"ru": "Выбранный файл не поддерживается",
				"en": "The file is not supported!"
			},
			{
				id: "broken_book",
				"ru": "Книга повреждена",
				"en": "The book is broken!"
			},
			{
				id: "broken_archive",
				"ru": "Архив поврежден",
				"en": "The archive is broken!"
			},
			{
				id: "loading",
				"ru": "Загрузка...",
				"en": "Loading..."
			},
			{
				id: "notitle",
				"ru": "Нет оглавления",
				"en": "No titles"
			},
			{
				id: "nobookmarks",
				"ru": "Нет закладок",
				"en": "No bookmarks"
			},

		];

		const app = new Vue({
			el: "#app",
			data: {
				xml: null,
				showNotes: false,
				book: {
					title: "",
					author: "",
					cover: "",
					main: "",
					notes: "",
					hash: "",
					chapters: [],
					annotation: ""
				},
				options: {
					fontSize: 16,
					color: "#000000",
					background: "#FFFFFF",
					links: "#00AAFF",
					fontFamily: "Verdana,sans-serif",
					theme: "#000000/#FFFFFF/#00AAFF",
					figure: "transparent",
					tab: 1,
					pin: false
				},
				locale: navigator.language || navigator.userLanguage || "en",
				translations: translations,
				percent: 0,
				currentChapter: 0,
				scrollTop: 0,
				loading: true,
				bookmarks: []
			},
			mounted() {

				this.loading = true;

				window.addEventListener('scroll', this.scroll);

				window.addEventListener("hashchange", () => {
					this.showNotes = true;
				});

				document.querySelector(".page").addEventListener("click", this.pageDblClick);

				let query = SimpleIDB.initialize();
				query.catch((error) => {
					alert(error)
				});

				query = SimpleIDB.get("fb2Reader_book");
				query.then((value) => {
					if (value != undefined) {
						this.book = JSON.parse(value);
						this.restoreProgress();
					}
					this.loading = false;
				}).catch((error) => {
					alert(error);
					this.loading = false;
				});

				if (localStorage['fb2Reader_options']) {
					this.options = JSON.parse(localStorage['fb2Reader_options']);
				}

			},
			updated() {
				localStorage.setItem("fb2Reader_options", JSON.stringify(this.options));
			},
			methods: {
				open() {
					function error() {
						alert(this.lang("not_supported"));
					}
					let that = this;
					let div = document.createElement('div');
					div.innerHTML = '<input type="file" accept=".fb2,.fb2.zip">';
					let fileInput = div.firstChild;
					fileInput.addEventListener('change', function() {
						let file = fileInput.files[0];
						that.loading = true;
						if (file.name.match(/\.(fb2)$/)) {

							let reader = new FileReader();
							reader.onload = function() {
								that.parse(reader.result);
								div.remove();
							}
							reader.readAsArrayBuffer(file);

						} else if (file.name.match(/\.fb2\.zip$/)) {

							JSZip.loadAsync(file).then(function(zip) {

								let file = zip.file(/\.fb2$/);
								if (file[0] != undefined) {
									file[0].async("arraybuffer").then(function(result) {
										that.parse(result);
									});
								} else {
									alert(this.lang("not_supported"));
								}
							}).catch(err => that.lang("broken_archive"));
						} else {
							error();
							div.remove();
							that.loading = false;
						}
					});
					fileInput.click();
				},
				parse(buffer) {
					let decoder = new TextDecoder();
					let parser = new DOMParser();
					let xml = null,
						text = "";
					try {
						text = decoder.decode(buffer);
						xml = parser.parseFromString(text, "text/xml");
						if (xml.xmlEncoding != 'utf-8') {
							decoder = new TextDecoder(xml.xmlEncoding);
							text = decoder.decode(buffer);
							xml = parser.parseFromString(text, "text/xml");
						}
						this.loading = false;
					} catch {
						alert(this.lang("broken_book"));
						this.loading = false;
						return;
					}
					if (xml.getElementsByTagName("FictionBook").length == 0) {
						alert(this.lang("broken_book"));
						this.loading = false;
						return;
					}

					this.xml = xml;

					let title = this.nodeText(xml.getElementsByTagName("book-title")[0]);

					this.book.title = title;
					this.book.hash = this.hashCode(title);

					let author = xml.getElementsByTagName("author")[0];
					if (author != null) {
						this.book.author = this.getFullNane(author);
					}

					this.book.cover = "";

					let coverpage = xml.getElementsByTagName("coverpage")[0];
					if (coverpage != null) {
						let cover = coverpage.getElementsByTagName("image")[0];
						if (cover != null) {
							let id = cover.getAttribute("l:href") || cover.getAttribute("xlink:href");
							id = id.replace(/#/g, '');
							let binary = xml.getElementById(id);
							if (binary != null) {
								let type = binary.getAttribute("content-type");
								let base64 = binary.childNodes[0].nodeValue;
								this.book.cover = `data:${type};base64, ${base64}`;
							}
						}
					}

					this.book.annotation = "";
					this.book.sequence = "";

					let annotation = xml.getElementsByTagName("annotation")[0];

					if (annotation != null) {
						this.book.annotation = this.parseNode(annotation, 1);
					}

					let sequence = xml.getElementsByTagName("sequence")[0];

					if (sequence != null) {
						let sequenceText = sequence.getAttribute("name");
						if (sequence.getAttribute("number") != undefined) {
							sequenceText += " №" + sequence.getAttribute("number");
						}
						this.book.sequence = sequenceText;
					}

					let bodys = xml.getElementsByTagName("body");

					this.book.main = "";
					this.book.notes = "";
					this.book.chapters = [];

					for (let i = 0; i < bodys.length; i++) {
						if (i == 0) {
							this.book.main = this.parseNode(bodys[i], i);
						} else {
							this.book.notes += this.parseNode(bodys[i], i);
						}
					}


					let query = SimpleIDB.set("fb2Reader_book", JSON.stringify(this.book));
					query.catch((error) => {
						alert(error)
					});


					this.restoreProgress();
				},
				getFullNane(node) {
					let fullName = [];
					fullName.push(this.nodeText(node.getElementsByTagName("first-name")[0]));
					fullName.push(this.nodeText(node.getElementsByTagName("middle-name")[0]));
					fullName.push(this.nodeText(node.getElementsByTagName("last-name")[0]));
					fullName.push(this.nodeText(node.getElementsByTagName("nick-name")[0]));
					return fullName.join(" ");
				},
				parseNode(node, i, deep = -2) {
					output = "";

					if (node.nodeType == 1) {

						let that = this;
						let tags = {
							body: {
								start(node) {
									return "<div class='body'>"
								},
								end: "</div>"
							},
							annotation: {
								start(node) {
									return "<div class='annotation'>"
								},
								end: "</div>"
							},
							section: {
								start(node) {
									let id = node.getAttribute("id");
									return id != undefined ? `<section id='${id}'>` : "<section>";
								},
								end: "</section>"
							},
							p: {
								start(node) {
									if (node.textContent[0]=="—" ||node.textContent[0]=="–") {
										return "<p class='mark dialogue'>";
									} else {
										return (i==0) ? "<p class='mark'>" : "<p>";
									}
									
								},
								end: "</p>"
							},
							title: {
								start(node) {
									let title = [];
									for (let p of node.getElementsByTagName("p")) {
										let t = "";
										for (let node of p.childNodes) {
											if (node.nodeType==1 && node.nodeName != "a") {
												t+= node.textContent;
											}
											if (node.nodeType == 3) {
												t+= node.nodeValue;
											}
										}
										title.push(t);
									}
									if (i == 0) {
										that.book.chapters.push({
											deep: deep,
											title: title.join(" - ")
										});
									}
									return "<div class='title mark'>"
								},
								end: "</div>"
							},
							subtitle: {
								start(node) {
									return "<div class='subtitle mark'>"
								},
								end: "</div>"
							},
							"empty-line": {
								start(node) {
									return "<div class='line'>"
								},
								end: "</div>"
							},
							emphasis: {
								start(node) {
									return "<em>"
								},
								end: "</em>"
							},
							strong: {
								start(node) {
									return "<b>"
								},
								end: "</b>"
							},
							epigraph: {
								start(node) {
									return "<div class='epigraph mark'>"
								},
								end: "</div>"
							},
							cite: {
								start(node) {
									return "<blockquote class='mark'>"
								},
								end: "</blockquote>"
							},
							"text-author": {
								start(node) {
									return "<cite>"
								},
								end: "</cite>"
							},
							date: {
								start(node) {
									return "<date>"
								},
								end: "</date>"
							},
							poem: {
								start(node) {
									return "<div class='poem mark'>"
								},
								end: "</div>"
							},
							stanza: {
								start(node) {
									return "<div class='stanza mark'>"
								},
								end: "</div>"
							},
							v: {
								start(node) {
									return "<p class='mark'>"
								},
								end: "</p>"
							},
							image: {
								start(node) {

									let id = node.getAttribute("l:href") || node.getAttribute("xlink:href");
									id = id.replace(/#/g, '');
									let binary = that.xml.getElementById(id);
									if (binary != null) {
										let type = binary.getAttribute("content-type");
										let base64 = binary.childNodes[0].nodeValue;
										return `<figure><img src="data:${type};base64,${base64}" onload="app.loadImage(event)"></figure>`
									} else {
										return "";
									}
								},
								end: ""
							},
							a: {
								start(node) {
									let href = node.getAttribute("l:href") || node.getAttribute("xlink:href");
									let text = node.textContent.replace(/[\{\}\[\]\(\)]/gi, '');
									return href[0]=="#" ? `<sup><a href='${href}'>${text}</a></sup>` : `<a href='${href}'>${text}</a>`
								},
								end: ""
							},
							link: {
								start(node) {
									let href = node.getAttribute("l:href") || node.getAttribute("xlink:href");
									let text = node.textContent.replace(/[\{\}\[\]\(\)]/gi, '');
									return href[0]=="#" ? `<sup><a href='${href}'>${text}</a></sup>` : `<a href='${href}'>${text}</a>`
								},
								end: ""
							}
						}

						if (tags[node.nodeName] != undefined) {

							output += tags[node.nodeName].start(node);
							let end = tags[node.nodeName].end;

							if (end != "") {
								for (let childNode of node.childNodes) {
									output += this.parseNode(childNode, i, deep + 1);
								}
								output += end;
							}
						}

					} else if (node.nodeType == 3) {
						let text = node.nodeValue;

						if (node.parentNode.nodeName == "p" && node.parentNode.parentNode.name == "title") {
							//nothing
						} else {
							text = text.replace(/(\s)(\S+)$/gm, "&nbsp;$2");
							text = text.replace(/(\s\S{1,3})(\s)(\S+)/gm, "$1&nbsp;$3");
							text = text.replace(/(\d)(\s)(\S+)/gm, "$1&nbsp;$3");
							text = text.replace(/(\s)(—)/gm, "&nbsp;$2");
							text = text.replace(/(\S)(-)(\S)/gm, "$1&#x2060;$2&#x2060;$3");
						}
						output += text;
					}

					return output;
				},
				theme(event) {
					let theme = event.target.value;
					if (theme == "custom") return;
					theme = theme.split("/");
					this.options.color = theme[0];
					this.options.background = theme[1];
					this.options.links = theme[2];
				},
				hashCode(s) {
					return s.split("").reduce(function(a, b) {
						a = ((a << 5) - a) + b.charCodeAt(0);
						return a & a
					}, 0);
				},
				restoreProgress() {

					this.bookmarks = [];

					this.$nextTick(function() {

						if (localStorage["fb2Reader_scroll" + this.book.hash]) {
							let i = localStorage.getItem("fb2Reader_scroll" + this.book.hash);
							setTimeout(() => {
								let p = document.querySelectorAll(".page .mark");
								if (p.length > i) {
									p[i].scrollIntoView();
								}
							}, 100);
						}

						if (localStorage["fb2Reader_bookmarks" + this.book.hash]) {
							let bm = localStorage.getItem("fb2Reader_bookmarks" + this.book.hash);
							this.bookmarks = JSON.parse(bm);
							setTimeout(() => {
								let marks = document.querySelectorAll(".page p.mark");
								for (let bookmark of this.bookmarks) {
									marks[bookmark.number].classList.add("checked");
								}
							}, 100);
						}
					});

				},
				nodeText(node) {
					if (node != null && node != undefined && node.childNodes.length > 0) {
						return node.childNodes[0].nodeValue;
					} else {
						return "";
					}
				},
				hideNotes() {
					if (this.showNotes) {
						this.showNotes = false;
						history.pushState(null, null, ' ');
					}
				},
				lang(id) {
					translation = this.translations.find(z => z.id == id);
					if (translation) {
						if (translation.hasOwnProperty(this.locale)) {
							return translation[this.locale];
						} else {
							return translation["en"];
						}
					}
				},
				scrollPercent() {
					this.percent = ((document.documentElement.scrollTop + document.body.scrollTop) / (document.documentElement.scrollHeight - document.documentElement.clientHeight) * 100).toFixed(2);
				},
				goChapter(i) {
					let chapters = document.getElementsByClassName('title');
					chapters[i].scrollIntoView();
				},
				sizeChanged(e) {
					e.preventDefault();
					this.restoreProgress();
				},
				scroll() {
					this.hideNotes();
					this.scrollPercent();
					let marks = document.querySelectorAll(".page .mark");
					let wt = window.pageYOffset || document.documentElement.scrollTop;

					for (let mark of marks) {
						let bt = mark.offsetTop + mark.offsetHeight;

						if (bt >= wt) {
							this.scrollTop = Array.prototype.indexOf.call(marks, mark);
							break;
						}
					}

					localStorage.setItem("fb2Reader_scroll" + this.book.hash, this.scrollTop);

					let titles = document.querySelectorAll(".page .title"),
						number = 0;

					for (let title of titles) {
						let bt = title.offsetTop - 2 * this.options.fontSize;
						if (bt < wt) {
							number = Array.prototype.indexOf.call(titles, title);
						} else {
							break;
						}
					}

					this.currentChapter = number;
				},
				pageDblClick(e) {
					target = e.target;

					if (target.nodeName =="P" && target.classList.contains("mark")) {
						let marks = document.querySelectorAll(".page p.mark");
						let i = Array.prototype.indexOf.call(marks, target);
						let bookmark = this.bookmarks.find(z => z.number == i);

						if (bookmark) {
							target.classList.remove("checked");
							this.bookmarks = this.bookmarks.filter(z => z.number != i);
						} else {
							target.classList.add("checked");

							let parent = target.closest("section"), title="";

							if (parent) {
								titleP = parent.querySelector(".title p:last-child");
								if (titleP) title = titleP.innerText;
							}

							this.bookmarks.push({
								number: i,
								title: title
							});
						}

						this.bookmarks = this.bookmarks.sort((a,b)=>{
							return a.number - b.number;
						});

						localStorage.setItem("fb2Reader_bookmarks" + this.book.hash, JSON.stringify(this.bookmarks));
					}
				},
				goBookmark(number) {
					let marks = document.querySelectorAll(".page p.mark");
					marks[number].scrollIntoView();
				},
				loadImage(event) {
					let width = event.target.naturalWidth, height = event.target.naturalHeight;
					if (width != undefined && width<300 && height !=undefined && height < 300) {
						event.target.parentNode.classList.add("float");
					}
				}
			},
			computed: {
				style() {
					return {
						fontSize: this.options.fontSize + "px",
						fontFamily: this.options.fontFamily,
						color: this.options.color,
						background: this.options.background
					}
				},
				moreStyles() {
					return `<style>
						a {
							color: ${this.options.links}
						}
						.page *::selection, .notes *::selection {
							background-color: ${this.options.color};
							color: ${this.options.background};
						}

						blockquote {
							border-left: 0.4em solid ${this.options.color};
						}

						body::-webkit-scrollbar-track, .notes .scroll::-webkit-scrollbar-track {
							background: ${this.options.background};
						}

						body::-webkit-scrollbar-thumb, .notes .scroll::-webkit-scrollbar-thumb {
							background-color: ${this.options.color}; 
						}

						.notes {
							border-top: 1px solid ${this.options.color};
							background-color: ${this.options.background};
						}

						figure {
							background-color: ${this.options.figure};
						}
						</style>`;
				}
			}
		});
	</script>
</body>

</html>