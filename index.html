<!DOCTYPE html>
<html lang="ru">
	<!--
	License MIT - https://opensource.org/licenses/MIT
	Copyright (c) 2021 Talleyran, me@talleyran.ru
-->

	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>FB2 reader</title>

		<meta name="theme-color" content="#eee" />

		<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.9/vue.min.js" integrity="sha512-deBbW1lpMT6h3gvOzmeMPft4pf9CMGjCKc5jSNq2pMSjtkMPuELbd4N3LKXVq/t1t6qco4q3u/XguyqGqlOMjA==" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.5.0/jszip.min.js" integrity="sha512-y3o0Z5TJF1UsKjs/jS2CDkeHN538bWsftxO9nctODL5W40nyXIbs0Pgyu7//icrQY9m6475gLaVr39i/uh/nLA==" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
		<link rel="icon" href="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='utf-8'%3F%3E%3Csvg version='1.1' id='icon' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' viewBox='0 0 296.999 296.999' style='enable-background:new 0 0 296.999 296.999;' xml:space='preserve'%3E%3Cg%3E%3Cg%3E%3Cg%3E%3Cpath d='M45.432,35.049c-0.008,0-0.017,0-0.025,0c-2.809,0-5.451,1.095-7.446,3.085c-2.017,2.012-3.128,4.691-3.128,7.543 v159.365c0,5.844,4.773,10.61,10.641,10.625c24.738,0.059,66.184,5.215,94.776,35.136V84.023c0-1.981-0.506-3.842-1.461-5.382 C115.322,40.849,70.226,35.107,45.432,35.049z'/%3E%3Cpath d='M262.167,205.042V45.676c0-2.852-1.111-5.531-3.128-7.543c-1.995-1.99-4.639-3.085-7.445-3.085c-0.009,0-0.018,0-0.026,0 c-24.793,0.059-69.889,5.801-93.357,43.593c-0.955,1.54-1.46,3.401-1.46,5.382v166.779 c28.592-29.921,70.038-35.077,94.776-35.136C257.394,215.651,262.167,210.885,262.167,205.042z'/%3E%3Cpath d='M286.373,71.801h-7.706v133.241c0,14.921-12.157,27.088-27.101,27.125c-20.983,0.05-55.581,4.153-80.084,27.344 c42.378-10.376,87.052-3.631,112.512,2.171c3.179,0.724,6.464-0.024,9.011-2.054c2.538-2.025,3.994-5.052,3.994-8.301V82.427 C297,76.568,292.232,71.801,286.373,71.801z'/%3E%3Cpath d='M18.332,205.042V71.801h-7.706C4.768,71.801,0,76.568,0,82.427v168.897c0,3.25,1.456,6.276,3.994,8.301 c2.545,2.029,5.827,2.78,9.011,2.054c25.46-5.803,70.135-12.547,112.511-2.171c-24.502-23.19-59.1-27.292-80.083-27.342 C30.49,232.13,18.332,219.963,18.332,205.042z'/%3E%3C/g%3E%3C/g%3E%3C/g%3E%3C/svg%3E%0A" type="image/svg+xml" />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,700;1,400&family=Roboto:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet" />
		<style>
			:root {
				--panel-bg: #fafafa;
				--panel-fg: #111;
				--tab-bg: #fff;
				--tab-inactive-bg: #eee;
			}

			@font-face {
				font-family: Fast_Sans;
				src: url("https://born2root.github.io/Fast-Font/Fast_Sans.ttf") format("truetype");
				font-display: swap;
				font-weight: 400;
				font-style: normal;
			}

			@font-face {
				font-family: Fast_Serif;
				src: url("https://born2root.github.io/Fast-Font/Fast_Serif.ttf") format("truetype");
				font-display: swap;
				font-weight: 400;
				font-style: normal;
			}

			.panel,
			.tab,
			.group,
			.scroll {
				box-sizing: border-box;
			}

			.panel.dark {
				--panel-bg: #333;
				--panel-fg: #ccc;
				--tab-bg: #222;
				--tab-inactive-bg: #444;
			}

			.panel {
				position: fixed;
				top: 0;
				left: -18rem;
				font-family: Verdana, Geneva, Tahoma, sans-serif;
				background-color: var(--panel-bg);
				color: var(--panel-fg);
				height: 100vh;
				width: 18rem;
				font-size: 1rem;
				transition-property: left;
				transition-duration: 0.5s;
				display: flex;
				flex-direction: column;
				border-right: 1px solid var(--tab-inactive-bg);
				z-index: 50;
			}

			.panel .tab {
				display: flex;
				flex-direction: column;
				position: relative;
				height: 100%;
				overflow: hidden;
				background-color: var(--tab-bg);
			}

			.panel .scroll {
				overflow-y: auto;
				overflow-x: hidden;
				width: 100%;
				height: 100%;
			}

			.panel .empty {
				color: gray;
				padding: 0.5rem;
				text-align: center;
				display: none;
			}

			.chapters:empty + .empty,
			.bookmarks:empty + .empty,
			.selections:empty + .empty {
				display: block;
			}

			.panel:after {
				content: "";
				display: block;
				position: absolute;
				top: 0;
				left: 100%;
				height: 100%;
				width: 2rem;
				text-align: center;
			}

			.panel:hover,
			.panel.active {
				left: 0;
			}

			.panel:hover + .hello,
			.panel.active + .hello {
				display: none;
			}

			.panel .group {
				padding: 0.5rem;
				color: var(--panel-fg);
			}

			.panel label {
				display: flex;
				color: var(--panel-fg);
				align-items: center;
			}

			.panel label + label {
				margin-top: 0.3rem;
			}

			.panel label span {
				width: 100%;
				display: block;
				margin-right: 0.2rem;
			}

			.panel button,
			.panel select,
			.panel input {
				font-size: 1rem;
				width: 100%;
				height: 1.5rem;
				outline: none;
				box-sizing: border-box;
				background-color: rgba(255, 255, 255, 0.5);
			}

			.panel input[type="checkbox"] {
				width: 1rem;
				height: 1rem;
				margin-right: 0.5rem;
			}

			body {
				font-size: 16px;
				margin: 0;
				padding: 0;
				overflow-x: hidden;
			}

			.book {
				min-height: 100vh;
			}

			.page {
				max-width: 40em;
				margin: 0 auto;
				padding-top: 2em;
				padding-right: 2rem;
				padding-left: 0.5rem;
				transition-duration: 0.5s;
				transition-property: padding;
			}

			.page.left {
				padding-left: 16.5rem;
			}

			.body {
				padding: 0.2em;
			}

			p {
				font-size: 1em;
				line-height: 1.5em;
			}

			img {
				display: block;
				margin: 0 auto;
				max-width: 100%;
				height: auto;
			}

			figure {
				display: block;
				margin: 1em auto;
				width: max-content;
				max-width: 100%;
			}

			figure.png {
				background-color: white;
			}

			.title {
				font-weight: bold;
				margin: 2em 0 1rem 0;
				text-rendering: optimizeLegibility;
				font-kerning: normal;
			}

			.title p {
				font-size: 2em;
				text-indent: 0;
				text-align: left;
			}

			.title p + p {
				font-size: 1.5em;
			}

			.subtitle {
				text-align: center;
			}

			.epigraph {
				max-width: 60%;
				margin-left: auto;
			}

			blockquote {
				border-left: 0.4em solid black;
				padding-left: 1em;
				margin: 1em 0;
			}

			.scroll::-webkit-scrollbar {
				width: 0.4rem;
			}

			.scroll::-webkit-scrollbar-track {
				background: rgba(0, 0, 0, 0.2);
			}

			.scroll::-webkit-scrollbar-thumb {
				background-color: rgba(0, 0, 0, 0.4);
				border-radius: 20px;
			}

			body::-webkit-scrollbar,
			.notes .scroll::-webkit-scrollbar {
				width: 0.4rem;
			}

			body::-webkit-scrollbar-thumb,
			.notes .scroll::-webkit-scrollbar-thumb {
				border-radius: 20px;
			}

			.notes {
				position: fixed;
				max-width: 42em;
				height: 30vh;
				left: 0;
				right: 0;
				bottom: -31vh;
				margin: 0 auto;
				transition-property: bottom left;
				transition-duration: 0.5s;
			}

			.notes .scroll {
				height: 100%;
				overflow-y: scroll;
			}

			.notes.show {
				bottom: 0;
			}

			.notes .title {
				margin: 1em 0;
			}

			.notes p {
				font-size: 0.8em;
				text-indent: 0;
			}

			.notes .title p {
				font-size: 1em;
			}

			.notes .close {
				border: 0;
				background-color: transparent;
				outline: none;
				color: currentColor;
				position: absolute;
				right: 0.4rem;
				top: 0;
				width: 2rem;
				cursor: pointer;
				font-size: 2rem;
				z-index: 100;
			}

			.notes .body {
				padding-right: 0.2em;
			}

			.notes.left {
				left: 16.5rem;
			}

			.panel .statusbar {
				background: rgba(0, 0, 0, 0.1);
			}

			.panel .statusbar .value {
				background: rgba(0, 0, 0, 0.1);
			}

			.panel .tabs {
				display: flex;
				background-color: var(--tab-inactive-bg);
			}

			.panel .tabs input {
				display: none;
			}

			.panel label {
				user-select: none;
			}

			.panel .tabs label {
				padding: 0.5rem;
				margin: 0;
				width: 100%;
				justify-content: center;
				border-left: 1px solid transparent;
				border-right: 1px solid transparent;
			}

			.panel .tabs input:checked + label {
				background-color: var(--tab-bg);
			}

			.panel .tabs input:checked + label:not(:last-of-type) {
				border-right-color: var(--tab-inactive-bg);
			}

			.panel .tabs input:checked + label:not(:first-of-type) {
				border-left-color: var(--tab-inactive-bg);
			}

			.panel .tabs label.pin {
				width: 1rem;
				color: rgba(1, 1, 1, 0.2);
				border-left-color: transparent !important;
			}

			.panel .tabs input:checked + label.pin {
				background-color: transparent !important;
				color: rgba(0, 170, 255);
			}

			.panel .chapters,
			.panel .bookmarks,
			.panel .selections {
				padding: 0;
				margin: 0;
			}

			.panel .chapter,
			.panel .bookmark,
			.panel .selection {
				list-style: none;
				display: flex;
				cursor: pointer;
				color: var(--panel-fg);
				user-select: none;
				padding: 0.3rem 0.5rem;
			}

			.panel .bookmark span:empty {
				display: none;
			}

			.panel .bookmark span:last-of-type {
				margin-left: auto;
				padding-left: 1rem;
			}

			.panel .chapter:empty {
				display: none;
			}

			.panel .chapter:hover,
			.panel .bookmark:hover,
			.panel .selection:hover,
			.chapter.active {
				background-color: rgba(0, 0, 0, 0.05);
			}

			.panel .chapter.active {
				text-shadow: 0 0 1px black;
				background-color: rgba(0, 0, 0, 0.1);
			}

			.icon {
				display: inline-block;
				width: 1em;
				height: 1em;
				stroke-width: 0;
				stroke: currentColor;
				fill: currentColor;
			}

			label .icon {
				width: 2rem;
			}

			.panel img {
				width: 100%;
			}

			.panel p {
				text-indent: 0;
			}

			.loading {
				font-size: 1em;
				font-family: Verdana, Geneva, Tahoma, sans-serif;
				transition-property: left;
				transition-duration: 0.5s;
				position: fixed;
				top: 0;
				left: 0;
				bottom: 0;
				right: 0;
				margin: auto;
				width: 100%;
				text-align: center;
				padding-top: 5rem;
				height: 100vh;
				display: flex;
				background-color: inherit;
				justify-content: center;
				color: inherit;
				z-index: 1;
			}

			.loading svg {
				animation: rotation 2s infinite linear;
				margin-right: 1rem;
			}

			@keyframes rotation {
				from {
					-webkit-transform: rotate(0deg);
				}

				to {
					-webkit-transform: rotate(359deg);
				}
			}

			.hello {
				padding: 1rem;
				font-size: 1rem;
			}

			p.mark {
				position: relative;
			}

			p.mark:before {
				position: sticky;
				float: right;
				content: "";
				border: 12px solid currentColor;
				border-bottom-color: transparent;
				height: 0.5rem;
				margin-right: -2rem;
				margin-bottom: -0.5rem;
				top: 0.5rem;
				left: 100%;
				opacity: 0;
				transition-property: opacity;
				transition-duration: 0.5s;
			}

			p.mark.checked:before {
				opacity: 1;
			}

			a {
				text-decoration: none;
			}

			.annotation {
				font-size: 0.75rem;
			}

			picture.float {
				display: inline-block;
				margin: 0;
			}

			picture.float img {
				display: inline-block;
				margin: 0;
			}

			.btn-group {
				display: flex;
				gap: 1rem;
			}

			.switch {
				display: flex;
				margin-top: 0.3rem;
			}

			.switch input {
				visibility: hidden;
				width: 0;
				height: 0;
			}

			.switch input:checked + label {
				background-color: rgba(255, 255, 255, 0.8);
				color: black;
			}

			.switch label {
				width: 100%;
				display: inline-flex;
				align-items: center;
				justify-content: center;
				border: 1px solid gray;
				border-radius: 2px;
				background-color: rgba(255, 255, 255, 0.5);
				padding: 0.1rem 0;
				color: #555;
			}

			.switch label:hover {
				border: 1px solid #333;
			}

			.remBtn {
				width: auto !important;
				margin-right: 0.5rem;
			}

			.selectBtn {
				position: absolute;
				margin-left: 0.5rem;
			}
		</style>
	</head>

	<body>
		<svg style="display: none">
			<symbol id="icon-settings" viewBox="0 0 32 32">
				<path d="M29.181 19.070c-1.679-2.908-0.669-6.634 2.255-8.328l-3.145-5.447c-0.898 0.527-1.943 0.829-3.058 0.829-3.361 0-6.085-2.742-6.085-6.125h-6.289c0.008 1.044-0.252 2.103-0.811 3.070-1.679 2.908-5.411 3.897-8.339 2.211l-3.144 5.447c0.905 0.515 1.689 1.268 2.246 2.234 1.676 2.903 0.672 6.623-2.241 8.319l3.145 5.447c0.895-0.522 1.935-0.82 3.044-0.82 3.35 0 6.067 2.725 6.084 6.092h6.289c-0.003-1.034 0.259-2.080 0.811-3.038 1.676-2.903 5.399-3.894 8.325-2.219l3.145-5.447c-0.899-0.515-1.678-1.266-2.232-2.226zM16 22.479c-3.578 0-6.479-2.901-6.479-6.479s2.901-6.479 6.479-6.479c3.578 0 6.479 2.901 6.479 6.479s-2.901 6.479-6.479 6.479z"></path>
			</symbol>
			<symbol id="icon-book" viewBox="0 0 32 32">
				<path d="M28 4v26h-21c-1.657 0-3-1.343-3-3s1.343-3 3-3h19v-24h-20c-2.2 0-4 1.8-4 4v24c0 2.2 1.8 4 4 4h24v-28h-2z"></path>
				<path d="M7.002 26v0c-0.001 0-0.001 0-0.002 0-0.552 0-1 0.448-1 1s0.448 1 1 1c0.001 0 0.001-0 0.002-0v0h18.997v-2h-18.997z"></path>
			</symbol>
			<symbol id="icon-list" viewBox="0 0 32 32">
				<path d="M0 0h8v8h-8zM12 2h20v4h-20zM0 12h8v8h-8zM12 14h20v4h-20zM0 24h8v8h-8zM12 26h20v4h-20z"></path>
			</symbol>
			<symbol id="icon-pin" viewBox="0 0 20 20">
				<path d="M11 12h6v-1l-3-1v-8l3-1v-1h-14v1l3 1v8l-3 1v1h6v7l1 1 1-1v-7z"></path>
			</symbol>
			<symbol id="icon-spinner" viewBox="0 0 32 32">
				<path d="M32 16c-0.040-2.089-0.493-4.172-1.331-6.077-0.834-1.906-2.046-3.633-3.533-5.060-1.486-1.428-3.248-2.557-5.156-3.302-1.906-0.748-3.956-1.105-5.981-1.061-2.025 0.040-4.042 0.48-5.885 1.292-1.845 0.809-3.517 1.983-4.898 3.424s-2.474 3.147-3.193 4.994c-0.722 1.846-1.067 3.829-1.023 5.79 0.040 1.961 0.468 3.911 1.254 5.694 0.784 1.784 1.921 3.401 3.316 4.736 1.394 1.336 3.046 2.391 4.832 3.085 1.785 0.697 3.701 1.028 5.598 0.985 1.897-0.040 3.78-0.455 5.502-1.216 1.723-0.759 3.285-1.859 4.574-3.208 1.29-1.348 2.308-2.945 2.977-4.67 0.407-1.046 0.684-2.137 0.829-3.244 0.039 0.002 0.078 0.004 0.118 0.004 1.105 0 2-0.895 2-2 0-0.056-0.003-0.112-0.007-0.167h0.007zM28.822 21.311c-0.733 1.663-1.796 3.169-3.099 4.412s-2.844 2.225-4.508 2.868c-1.663 0.646-3.447 0.952-5.215 0.909-1.769-0.041-3.519-0.429-5.119-1.14-1.602-0.708-3.053-1.734-4.25-2.991s-2.141-2.743-2.76-4.346c-0.621-1.603-0.913-3.319-0.871-5.024 0.041-1.705 0.417-3.388 1.102-4.928 0.683-1.541 1.672-2.937 2.883-4.088s2.642-2.058 4.184-2.652c1.542-0.596 3.192-0.875 4.832-0.833 1.641 0.041 3.257 0.404 4.736 1.064 1.48 0.658 2.82 1.609 3.926 2.774s1.975 2.54 2.543 4.021c0.57 1.481 0.837 3.064 0.794 4.641h0.007c-0.005 0.055-0.007 0.11-0.007 0.167 0 1.032 0.781 1.88 1.784 1.988-0.195 1.088-0.517 2.151-0.962 3.156z"></path>
			</symbol>
			<symbol id="icon-bookmark" viewBox="0 0 24 24">
				<path d="M17.016 3q0.797 0 1.383 0.609t0.586 1.406v15.984l-6.984-3-6.984 3v-15.984q0-0.797 0.586-1.406t1.383-0.609h10.031z"></path>
			</symbol>
			<symbol id="icon-palette" viewBox="0 0 24 24">
				<path d="M17.484 12q0.609 0 1.055-0.422t0.445-1.078-0.445-1.078-1.055-0.422-1.055 0.422-0.445 1.078 0.445 1.078 1.055 0.422zM14.484 8.016q0.609 0 1.055-0.445t0.445-1.055-0.445-1.055-1.055-0.445-1.055 0.445-0.445 1.055 0.445 1.055 1.055 0.445zM9.516 8.016q0.609 0 1.055-0.445t0.445-1.055-0.445-1.055-1.055-0.445-1.055 0.445-0.445 1.055 0.445 1.055 1.055 0.445zM6.516 12q0.609 0 1.055-0.422t0.445-1.078-0.445-1.078-1.055-0.422-1.055 0.422-0.445 1.078 0.445 1.078 1.055 0.422zM12 3q3.703 0 6.352 2.344t2.648 5.672q0 2.063-1.477 3.516t-3.539 1.453h-1.734q-0.656 0-1.078 0.445t-0.422 1.055q0 0.516 0.375 0.984t0.375 1.031q0 0.656-0.422 1.078t-1.078 0.422q-3.75 0-6.375-2.625t-2.625-6.375 2.625-6.375 6.375-2.625z"></path>
			</symbol>
			<symbol id="icon-font" viewBox="0 0 32 32">
				<path d="M24.987 0.506c-2.829 0-4.644-0.506-7.558-0.506-9.415 0-13.806 5.362-13.806 10.809 0 3.209 1.52 4.264 4.518 4.264-0.211-0.464-0.591-0.971-0.591-3.251 0-6.375 2.406-8.233 5.489-8.36 0 0-2.529 24.793-9.868 27.767v0.771h9.894l3.376-16h6.183l1.377-4h-6.716l1.623-7.693c1.858 0.38 3.673 0.76 5.235 0.76 1.942 0 3.715-0.591 4.686-5.066-1.182 0.38-2.449 0.506-3.842 0.506z"></path>
			</symbol>
			<symbol id="icon-font-size" viewBox="0 0 32 32">
				<path d="M28 24h4l-5 6-5-6h4v-16h-4l5-6 5 6h-4zM20 2v8l-2-4h-6v22h4v2h-12v-2h4v-22h-6l-2 4v-8z"></path>
			</symbol>
			<symbol id="icon-link-color" viewBox="0 0 24 24">
				<path d="M0 20.016h24v3.984h-24z"></path>
				<path d="M10.796 10.722c-0.217 0-0.433-0.085-0.598-0.254-1.548-1.584-1.548-4.161 0-5.746l3.125-3.197c0.75-0.767 1.747-1.19 2.808-1.19s2.058 0.423 2.808 1.19c1.548 1.584 1.548 4.161 0 5.746l-1.429 1.462c-0.331 0.338-0.866 0.338-1.197 0s-0.331-0.886 0-1.224l1.429-1.462c0.888-0.909 0.888-2.388 0-3.297-0.43-0.44-1.003-0.683-1.611-0.683s-1.181 0.242-1.611 0.683l-3.125 3.197c-0.888 0.909-0.888 2.388 0 3.297 0.331 0.338 0.331 0.886 0 1.224-0.165 0.169-0.382 0.254-0.598 0.254z"></path>
				<path d="M7.798 16.987c-1.061 0-2.058-0.423-2.808-1.19-1.548-1.584-1.548-4.161 0-5.746l1.429-1.462c0.331-0.338 0.867-0.338 1.197 0s0.331 0.886 0 1.224l-1.429 1.462c-0.888 0.909-0.888 2.388 0 3.297 0.43 0.44 1.003 0.683 1.611 0.683s1.181-0.242 1.611-0.683l3.125-3.197c0.888-0.909 0.888-2.388 0-3.297-0.331-0.338-0.331-0.886 0-1.224s0.866-0.338 1.197 0c1.548 1.584 1.548 4.161 0 5.746l-3.125 3.197c-0.75 0.767-1.747 1.19-2.808 1.19z"></path>
			</symbol>
			<symbol id="icon-text-color" viewBox="0 0 24 24">
				<path d="M0 20.016h24v3.984h-24z"></path>
				<path d="M20.368 0.159v6.695l-1.674-3.347h-5.021v11.716h3.347v1.674h-10.042v-1.674h3.347v-11.716h-5.021l-1.674 3.347v-6.695z"></path>
			</symbol>
			<symbol id="icon-bg-color" viewBox="0 0 24 24">
				<path d="M0 20.016h24v3.984h-24v-3.984zM18.984 11.484q2.016 2.203 2.016 3.516 0 0.797-0.609 1.406t-1.406 0.609-1.383-0.609-0.586-1.406q0-0.563 0.492-1.453t0.961-1.453zM5.203 9.984h9.609l-4.828-4.781zM16.547 8.953q0.469 0.469 0.469 1.078t-0.469 1.031l-5.484 5.484q-0.469 0.469-1.078 0.469-0.563 0-1.031-0.469l-5.531-5.484q-0.422-0.422-0.422-1.078 0-0.609 0.422-1.031l5.156-5.156-2.391-2.391 1.453-1.406z"></path>
			</symbol>
			<symbol id="icon-text-indent" viewBox="0 0 32 32">
				<path d="M7.201 6.091h22.151v2.373h-22.151v-2.373z"></path>
				<path d="M2.422 11.967h26.93v2.373h-26.93v-2.373z"></path>
				<path d="M7.201 17.844h22.151v2.373h-22.151v-2.373z"></path>
				<path d="M2.422 23.72h26.93v2.373h-26.93v-2.373z"></path>
			</symbol>
			<symbol id="icon-para-indent" viewBox="0 0 32 32">
				<path d="M2.375 4.091h26.977v2.373h-26.977v-2.373z"></path>
				<path d="M2.422 9.967h26.93v2.373h-26.93v-2.373z"></path>
				<path d="M2.415 19.844h26.937v2.373h-26.937v-2.373z"></path>
				<path d="M2.422 25.72h26.93v2.373h-26.93v-2.373z"></path>
			</symbol>
			<symbol id="icon-align-justify" viewBox="0 0 32 32">
				<path d="M2.375 4.091h26.977v2.373h-26.977v-2.373z"></path>
				<path d="M2.422 11.3h26.93v2.373h-26.93v-2.373z"></path>
				<path d="M2.415 18.51h26.937v2.373h-26.937v-2.373z"></path>
				<path d="M2.422 25.72h26.93v2.373h-26.93v-2.373z"></path>
			</symbol>
			<symbol id="icon-align-left" viewBox="0 0 32 32">
				<path d="M2.375 4.091h26.977v2.373h-26.977v-2.373z"></path>
				<path d="M2.422 11.3h19.714v2.373h-19.714v-2.373z"></path>
				<path d="M2.415 18.51h23.581v2.373h-23.581v-2.373z"></path>
				<path d="M2.422 25.72h26.93v2.373h-26.93v-2.373z"></path>
			</symbol>
			<symbol id="icon-highlight" viewBox="0 0 32 32">
				<path d="M29.333 26.667l-2.667 2.667h-17.333l2.667-2.667h17.333zM6.573 21.521l3.906 3.906-3.813 1.906-2.667 0.667 0.667-2.667 1.906-3.813zM7.819 14.766l9.44 9.44-0.323 0.332-0.367-0.018-0.385-0.006c-0.655 0-1.383 0.051-2.184 0.153l-0.502 0.070-0.49 0.081-0.469 0.087-0.577 0.119-4.902-4.902c0.097-0.392 0.196-0.878 0.274-1.455 0.158-1.171 0.216-2.356 0.174-3.556l0.207-0.233 0.104-0.111zM21.645 2.81l7.542 7.542-1.127 1.453-2.035 2.594-1.194 1.498-1.063 1.313-0.712 0.863-0.835 0.989-0.541 0.62-0.468 0.516-0.395 0.412-0.937 0.927-1.691 1.716-9.441-9.441 0.16-0.164 2.366-2.352 0.729-0.7 0.811-0.743 0.707-0.625 0.76-0.652 0.812-0.68 0.864-0.707 0.916-0.734 1.473-1.153 1.047-0.803 1.099-0.83 1.152-0.858z"></path>
			</symbol>
			<symbol id="icon-line-indent" viewBox="0 0 24 24">
				<path d="M9.984 12.984v-1.969h12v1.969h-12zM9.984 18.984v-1.969h12v1.969h-12zM9.984 5.016h12v1.969h-12v-1.969zM6 6.984v10.031h2.484l-3.469 3.469-3.516-3.469h2.484v-10.031h-2.484l3.516-3.469 3.469 3.469h-2.484z"></path>
			</symbol>
			<symbol id="icon-moon" viewBox="0 0 24 24">
				<path d="M21.996 12.882c0.022-0.233-0.038-0.476-0.188-0.681-0.325-0.446-0.951-0.544-1.397-0.219-0.95 0.693-2.060 1.086-3.188 1.162-1.368 0.092-2.765-0.283-3.95-1.158-1.333-0.985-2.139-2.415-2.367-3.935s0.124-3.124 1.109-4.456c0.142-0.191 0.216-0.435 0.191-0.691-0.053-0.55-0.542-0.952-1.092-0.898-2.258 0.22-4.314 1.18-5.895 2.651-1.736 1.615-2.902 3.847-3.137 6.386-0.254 2.749 0.631 5.343 2.266 7.311s4.022 3.313 6.772 3.567 5.343-0.631 7.311-2.266 3.313-4.022 3.567-6.772zM19.567 14.674c-0.49 1.363-1.335 2.543-2.416 3.441-1.576 1.309-3.648 2.016-5.848 1.813s-4.108-1.278-5.417-2.854-2.016-3.648-1.813-5.848c0.187-2.032 1.117-3.814 2.507-5.106 0.782-0.728 1.71-1.3 2.731-1.672-0.456 1.264-0.577 2.606-0.384 3.899 0.303 2.023 1.38 3.934 3.156 5.247 1.578 1.167 3.448 1.668 5.272 1.545 0.752-0.050 1.496-0.207 2.21-0.465z"></path>
			</symbol>
		</svg>

		<div id="app">
			<div class="book" :style="style">
				<div class="panel" :class="{active:options.pin, dark:options.dark}">
					<div class="tabs">
						<input type="radio" value="1" v-model.number="options.tab" id="tab1" /><label for="tab1"
							><svg class="icon">
								<use xlink:href="#icon-book"></use></svg
						></label>
						<input type="radio" value="2" v-model.number="options.tab" id="tab2" /><label for="tab2"
							><svg class="icon">
								<use xlink:href="#icon-list"></use></svg
						></label>
						<input type="radio" value="3" v-model.number="options.tab" id="tab3" /><label for="tab3"
							><svg class="icon">
								<use xlink:href="#icon-bookmark"></use></svg
						></label>
						<input type="radio" value="5" v-model.number="options.tab" id="tab5" /><label for="tab5"
							><svg class="icon">
								<use xlink:href="#icon-highlight"></use></svg
						></label>
						<input type="radio" value="4" v-model.number="options.tab" id="tab4" /><label for="tab4"
							><svg class="icon">
								<use xlink:href="#icon-settings"></use></svg
						></label>
						<input type="checkbox" v-model="options.pin" id="pin" /><label class="pin" for="pin"
							><svg class="icon icon-pin">
								<use xlink:href="#icon-pin"></use></svg
						></label>
					</div>
					<div v-show="options.tab==1" class="tab">
						<div class="group btn-group">
							<button class="btn" @click="open">{{lang("open")}}</button>
							<button class="btn" @click="close" :disabled="book.hash==''">{{lang("close")}}</button>
						</div>
						<div class="scroll" v-if="book.hash!=''">
							<div class="group">
								<img :src="book.cover" />
								<div class="statusbar">
									<div class="value" :style="{width:percent + '%'}">{{percent}}%</div>
								</div>
							</div>
							<div class="group">
								<div>{{book.author}}</div>
								<div><b>{{book.title}}</b></div>
								<div><i>{{book.sequence}}</i></div>
							</div>
							<div class="group">
								<div v-html="book.annotation"></div>
							</div>
						</div>
					</div>
					<div v-show="options.tab==2" class="tab">
						<div class="scroll">
							<ul class="chapters">
								<li class="chapter" v-for="(chapter,i) in book.chapters" :class="{active:i==currentChapter}" @click="goChapter(i)" v-if="chapter.deep>-1 && chapter.title!=''">
									<span :style="{minWidth:chapter.deep + 'rem'}"></span>
									<span>{{chapter.title}}</span>
								</li>
							</ul>
							<div class="empty">{{lang("notitle")}}</div>
						</div>
					</div>
					<div v-show="options.tab==3" class="tab">
						<div class="scroll">
							<ul class="bookmarks">
								<li class="bookmark" v-for="bookmark in bookmarks" @click="goBookmark(bookmark.number)">
									<button class="remBtn" @click="remBookmark(bookmark)">&times;</button>
									<span>{{bookmark.title}}</span>
									<span>&sect;&nbsp;{{bookmark.number}}</span>
								</li>
							</ul>
							<div class="empty">{{lang("nobookmarks")}}</div>
						</div>
					</div>
					<div v-show="options.tab==5" class="tab">
						<div class="group btn-group" v-if="selections.length>0">
							<button @click="saveQuotes('md')">{{lang("export")}} .md</button>
							<button @click="saveQuotes('txt')">{{lang("export")}} .txt</button>
						</div>
						<div class="scroll">
							<ul class="selections">
								<li class="selection" v-for="selection in selections" @click="goSelection(selection.hash)"><button class="remBtn" @click="remSelection(selection)">&times;</button><span>{{selection.text}}</span></li>
							</ul>
							<div class="empty">{{lang("noselections")}}</div>
						</div>
					</div>
					<div v-show="options.tab==4" class="tab">
						<div class="scroll">
							<div class="group">
								<label for="dark_theme"><input type="checkbox" id="dark_theme" v-model="options.dark" @change="changeTheme" />{{lang("dark_theme")}}</label>
								<label :title="lang('theme')"
									><svg class="icon">
										<use xlink:href="#icon-palette"></use>
									</svg>
									<select @change="theme" v-model="options.theme" :style="{color:options.color,backgroundColor:options.background}">
										<option value="#000000/#FFFFFF/#00AAFF" style="color: #000000; background: #ffffff">Black on white</option>
										<option value="#111111/#FFFad6/#AD6410" style="color: #111111; background: #fffad6">Grey on yellow</option>
										<option value="#CCCCCC/#000000/#00AAFF" style="color: #cccccc; background: #000000">Grey on black</option>
										<option value="#5bae67/#000000/#8cae5b" style="color: #5bae67; background: #000000">Green on black</option>
										<option value="custom">Custom</option>
									</select>
								</label>
							</div>
							<div class="group" v-if="options.theme=='custom'">
								<label :title="lang('text')"
									><svg class="icon">
										<use xlink:href="#icon-text-color"></use></svg
									><input type="color" v-model="options.color"
								/></label>
								<label :title="lang('background')"
									><svg class="icon">
										<use xlink:href="#icon-bg-color"></use></svg
									><input type="color" v-model="options.background"
								/></label>
								<label :title="lang('links')"
									><svg class="icon">
										<use xlink:href="#icon-link-color"></use></svg
									><input type="color" v-model="options.links"
								/></label>
							</div>
							<div class="group">
								<label> <input type="checkbox" true-value="white" false-value="transparent" v-model="options.figure" />{{lang("white")}} </label>
							</div>
							<div class="group">
								<label :title="lang('font')"
									><svg class="icon">
										<use xlink:href="#icon-font"></use>
									</svg>
									<select v-model="options.fontFamily" :style="{fontFamily:options.fontFamily}" @change="sizeChanged">
										<option value="Roboto,sans-serif" style="font-family: Roboto, sans-serif">Roboto</option>
										<option value="Verdana,sans-serif" style="font-family: Verdana, sans-serif">Verdana</option>
										<option value="Fast_Sans,sans-serif" style="font-family: Fast_Sans, sans-serif">Fast_Sans (Bionic)</option>
										<option value="Helvetica,sans-serif" style="font-family: Helvetica, sans-serif">Helvetica</option>
										<option value="Georgia,serif" style="font-family: Georgia, serif">Georgia</option>
										<option value="'Times New Roman',serif" style="font-family: 'Times New Roman', serif">Times New Roman</option>
										<option value="'Fast_Serif',serif" style="font-family: 'Fast_Serif', serif">Fast_Serif (Bionic)</option>
										<option value="'EB Garamond',serif" style="font-family: 'EB Garamond', serif">Garamond</option>
									</select>
								</label>
								<label :title="lang('size')"
									><svg class="icon">
										<use xlink:href="#icon-font-size"></use>
									</svg>
									<select v-model.number="options.fontSize" @change="sizeChanged">
										<option value="12">12</option>
										<option value="14">14</option>
										<option value="16">16</option>
										<option value="18">18</option>
										<option value="20">20</option>
										<option value="22">22</option>
										<option value="24">24</option>
									</select>
								</label>
								<div class="switch">
									<input id="align-left" type="radio" value="left" v-model="options.textAlign" @change="sizeChanged" />
									<label for="align-left">
										<svg class="icon">
											<use xlink:href="#icon-align-left"></use>
										</svg>
									</label>
									<input id="align-justify" type="radio" value="justify" v-model="options.textAlign" @change="sizeChanged" />
									<label for="align-justify">
										<svg class="icon">
											<use xlink:href="#icon-align-justify"></use>
										</svg>
									</label>
								</div>
							</div>
							<div class="group">
								<label :title="lang('line_indent')">
									<svg class="icon">
										<use xlink:href="#icon-line-indent"></use>
									</svg>
									<select v-model.number="options.lineIndent" @change="sizeChanged">
										<option value="1">1</option>
										<option value="1.25">1.25</option>
										<option value="1.5">1.5</option>
										<option value="1.75">1.75</option>
										<option value="2">2</option>
										<option value="2.25">1.25</option>
										<option value="2.5">2.5</option>
									</select>
								</label>
								<label :title="lang('text_indent')">
									<svg class="icon">
										<use xlink:href="#icon-text-indent"></use>
									</svg>
									<select v-model.number="options.textIndent" @change="sizeChanged">
										<option value="0">0</option>
										<option value="0.5">0.5</option>
										<option value="1">1</option>
										<option value="1.5">1.5</option>
										<option value="2">2</option>
										<option value="2.5">2.5</option>
										<option value="3">3</option>
									</select>
								</label>
								<label :title="lang('para_indent')">
									<svg class="icon">
										<use xlink:href="#icon-para-indent"></use>
									</svg>
									<select v-model.number="options.paraIndent" @change="sizeChanged">
										<option value="0">0</option>
										<option value="0.5">0.5</option>
										<option value="1">1</option>
										<option value="1.5">1.5</option>
										<option value="2">2</option>
										<option value="2.5">2.5</option>
										<option value="3">3</option>
									</select>
								</label>
								<label v-if="options.paraIndent>0" for="merge_dialogues"><input type="checkbox" id="merge_dialogues" v-model="options.mergeDialogues" />{{lang("merge_dialogues")}}</label>
							</div>
						</div>
					</div>
				</div>
				<div class="hello" v-if="book.main==''">
					<svg class="icon">
						<use xlink:href="#icon-book"></use>
					</svg>
				</div>
				<div class="loading" v-if="loading" :class="{left:options.pin}">
					<svg class="icon icon-spinner">
						<use xlink:href="#icon-spinner"></use>
					</svg>
					{{lang('loading')}}
				</div>
				<div v-html="book.main" class="page" :class="{left:options.pin}"></div>
				<div class="notes" :class="{'show':showNotes,'left':options.pin}">
					<button class="close" @click="hideNotes">&times;</button>
					<div v-html="book.notes" class="scroll"></div>
				</div>
				<div v-html="moreStyles"></div>
			</div>
		</div>

		<script>
			const SimpleIDB = {
				dbName: "myDatabase",
				storeName: "myStore",

				initialize() {
					let that = this;
					window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;

					return new Promise((resolve, reject) => {
						let request = indexedDB.open(that.dbName);
						request.onupgradeneeded = function () {
							request.result.createObjectStore(that.storeName);
							resolve();
						};
						request.onerror = function () {
							reject(request.error);
						};
					});
				},

				get(key) {
					let that = this;
					return new Promise((resolve, reject) => {
						let oRequest = indexedDB.open(that.dbName);
						oRequest.onsuccess = function () {
							let db = oRequest.result;
							let tx = db.transaction(that.storeName, "readonly");
							let st = tx.objectStore(that.storeName);
							let gRequest = st.get(key);
							gRequest.onsuccess = function () {
								resolve(gRequest.result);
							};
							gRequest.onerror = function () {
								reject(gRequest.error);
							};
						};
						oRequest.onerror = function () {
							reject(oRequest.error);
						};
					});
				},

				set(key, value) {
					let that = this;
					return new Promise((resolve, reject) => {
						let oRequest = indexedDB.open(that.dbName);
						oRequest.onsuccess = function () {
							let db = oRequest.result;
							let tx = db.transaction(that.storeName, "readwrite");
							let st = tx.objectStore(that.storeName);
							let sRequest = st.put(value, key);
							sRequest.onsuccess = function () {
								resolve();
							};
							sRequest.onerror = function () {
								reject(sRequest.error);
							};
						};
						oRequest.onerror = function () {
							reject(oRequest.error);
						};
					});
				},

				remove(key) {
					let that = this;
					return new Promise((resolve, reject) => {
						let oRequest = indexedDB.open(that.dbName);
						oRequest.onsuccess = function () {
							let db = oRequest.result;
							let tx = db.transaction(that.storeName, "readwrite");
							let st = tx.objectStore(that.storeName);
							let rRequest = st.delete(key);
							rRequest.onsuccess = function () {
								resolve();
							};
							rRequest.onerror = function () {
								reject(rRequest.error);
							};
						};
						oRequest.onerror = function () {
							reject(oRequest.error);
						};
					});
				},
			};

			const translations = [
				{
					id: "text",
					ru: "Текст",
					en: "Text",
				},
				{
					id: "background",
					ru: "Фон",
					en: "Background",
				},
				{
					id: "links",
					ru: "Ссылки",
					en: "links",
				},
				{
					id: "font",
					ru: "Шрифт",
					en: "Font",
				},
				{
					id: "text",
					ru: "Текст",
					en: "Text",
				},
				{
					id: "theme",
					ru: "Тема",
					en: "Theme",
				},
				{
					id: "open",
					ru: "Открыть fb2",
					en: "Open fb2",
				},
				{
					id: "size",
					ru: "Размер шрифта",
					en: "Font size",
				},
				{
					id: "imgbg",
					ru: "Фон картинок",
					en: "Picture background",
				},
				{
					id: "not_supported",
					ru: "Выбранный файл не поддерживается",
					en: "The file is not supported!",
				},
				{
					id: "broken_book",
					ru: "Книга повреждена",
					en: "The book is broken!",
				},
				{
					id: "broken_archive",
					ru: "Архив поврежден",
					en: "The archive is broken!",
				},
				{
					id: "loading",
					ru: "Загрузка...",
					en: "Loading...",
				},
				{
					id: "notitle",
					ru: "Нет оглавления",
					en: "No titles",
				},
				{
					id: "nobookmarks",
					ru: "Нет закладок",
					en: "No bookmarks",
				},
				{
					id: "noselections",
					ru: "Нет цитат",
					en: "No quotes",
				},
				{
					id: "close",
					ru: "Очистить",
					en: "Clear",
				},
				{
					id: "remove_confirm",
					ru: "Точно удалить книгу, прогресс чтения и закладки из памяти браузера?",
					en: "Realy clear book, progress and bookmarks from the browser storage?",
				},
				{
					id: "merge_dialogues",
					ru: "Объединять диалоги",
					en: "Merge dialogues",
				},
				{
					id: "white",
					ru: "Белый фон картинок",
					en: "White",
				},
				{
					id: "text_indent",
					ru: "Отступ первой строки",
					en: "First line indent",
				},
				{
					id: "line_indent",
					ru: "Междустрочный интервал",
					en: "Line height",
				},
				{
					id: "para_indent",
					ru: "Отступ между параграфами",
					en: "Vertical indent",
				},
				{
					id: "add_quote",
					ru: "Добавить цитату",
					en: "Add selection as a Quote",
				},
				{
					id: "dark_theme",
					ru: "Темная тема",
					en: "Dark theme",
				},
				{
					id: "export",
					ru: "Экспорт",
					en: "Export",
				},
			];

			const app = new Vue({
				el: "#app",
				data: {
					xml: null,
					showNotes: false,
					book: {
						title: "",
						author: "",
						cover: "",
						main: "",
						notes: "",
						hash: "",
						chapters: [],
						annotation: "",
					},
					options: {
						fontSize: 16,
						color: "#000000",
						background: "#FFFFFF",
						links: "#00AAFF",
						fontFamily: "Verdana,sans-serif",
						theme: "#000000/#FFFFFF/#00AAFF",
						figure: "transparent",
						tab: 1,
						pin: false,
						textIndent: 0,
						paraIndent: 0,
						lineIndent: 1.5,
						dark: false,
					},
					locale: navigator.language || navigator.userLanguage || "en",
					translations: translations,
					percent: 0,
					currentChapter: 0,
					scrollTop: 0,
					loading: true,
					bookmarks: [],
					selections: [],
				},
				mounted() {
					this.loading = true;

					window.addEventListener("scroll", this.scroll);

					window.addEventListener("hashchange", () => {
						this.showNotes = true;
					});

					const page = document.querySelector(".page");
					this.mark = new Mark(page);

					page.addEventListener("mouseup", this.mouseUp);

					document.addEventListener("selectionchange", this.changeSelection);

					let query = SimpleIDB.initialize();
					query.catch((error) => {
						alert(error);
					});

					query = SimpleIDB.get("fb2Reader_book");
					query
						.then((value) => {
							if (value != undefined) {
								this.book = JSON.parse(value);
								this.restoreProgress();
							}
							this.loading = false;
						})
						.catch((error) => {
							alert(error);
							this.loading = false;
						});

					if (localStorage["fb2Reader_options"]) {
						let options = JSON.parse(localStorage["fb2Reader_options"]);
						this.options = options;

						if (this.options.textIndent == undefined) {
							this.options.textIndent = 0;
						}

						if (this.options.textAlign == undefined) {
							this.options.textAlign = "left";
						}

						if (this.options.paraIndent == undefined) {
							this.options.paraIndent = 1;
						}

						if (this.options.mergeDialogues == undefined) {
							this.options.mergeDialogues = false;
						}

						if (this.options.lineIndent == undefined) {
							this.options.lineIndent = 1.5;
						}

						this.changeTheme();
					}
				},
				updated() {
					localStorage.setItem("fb2Reader_options", JSON.stringify(this.options));
				},
				methods: {
					open() {
						let error = () => {
							alert(this.lang("not_supported"));
						};
						let that = this;
						let div = document.createElement("div");
						div.innerHTML = '<input type="file" accept=".fb2,.fb2.zip">';
						let fileInput = div.firstChild;
						fileInput.addEventListener("change", function () {
							let file = fileInput.files[0];
							that.loading = true;
							if (file.name.match(/\.(fb2)$/)) {
								let reader = new FileReader();
								reader.onload = function () {
									that.parse(reader.result);
									div.remove();
								};
								reader.readAsArrayBuffer(file);
							} else if (file.name.match(/\.fb2\.zip$/)) {
								JSZip.loadAsync(file)
									.then(function (zip) {
										let file = zip.file(/\.fb2$/);
										if (file[0] != undefined) {
											file[0].async("arraybuffer").then(function (result) {
												that.parse(result);
											});
										} else {
											alert(this.lang("not_supported"));
										}
									})
									.catch((err) => that.lang("broken_archive"));
							} else {
								error();
								div.remove();
								that.loading = false;
							}
						});
						fileInput.click();
					},
					parse(buffer) {
						let decoder = new TextDecoder();
						let parser = new DOMParser();
						let xml = null,
							text = "";
						try {
							text = decoder.decode(buffer);
							xml = parser.parseFromString(text, "text/xml");
							if (xml.xmlEncoding != "utf-8") {
								decoder = new TextDecoder(xml.xmlEncoding);
								text = decoder.decode(buffer);
								xml = parser.parseFromString(text, "text/xml");
							}
							this.loading = false;
						} catch (err) {
							alert(this.lang("broken_book"));
							console.error(err);
							this.loading = false;
							return;
						}
						if (xml.getElementsByTagName("FictionBook").length == 0) {
							alert(this.lang("broken_book"));
							this.loading = false;
							return;
						}

						try {
							this.xml = xml;

							let title = this.nodeText(xml.getElementsByTagName("book-title")[0]);

							this.book.title = title;
							this.book.hash = this.hashCode(title);

							let author = xml.getElementsByTagName("author")[0];
							if (author != null) {
								this.book.author = this.getFullNane(author);
							}

							this.book.cover = "";

							let coverpage = xml.getElementsByTagName("coverpage")[0];
							if (coverpage != null) {
								let cover = coverpage.getElementsByTagName("image")[0];
								if (cover != null) {
									let id = cover.getAttribute("l:href") || cover.getAttribute("xlink:href");
									id = id.replace(/#/g, "");
									let binary = xml.getElementById(id);
									if (binary != null) {
										let type = binary.getAttribute("content-type");
										let base64 = binary.childNodes[0].nodeValue;
										this.book.cover = `data:${type};base64, ${base64}`;
									}
								}
							}

							this.book.annotation = "";
							this.book.sequence = "";

							let annotation = xml.getElementsByTagName("annotation")[0];

							if (annotation != null) {
								this.book.annotation = this.parseNode(annotation, 1);
							}

							let sequence = xml.getElementsByTagName("sequence")[0];

							if (sequence != null) {
								let sequenceText = sequence.getAttribute("name");
								if (sequence.getAttribute("number") != undefined) {
									sequenceText += " №" + sequence.getAttribute("number");
								}
								this.book.sequence = sequenceText;
							}

							let bodys = xml.getElementsByTagName("body");

							this.book.main = "";
							this.book.notes = "";
							this.book.chapters = [];

							for (let i = 0; i < bodys.length; i++) {
								if (i == 0) {
									this.book.main = this.parseNode(bodys[i], i);
								} else {
									this.book.notes += this.parseNode(bodys[i], i);
								}
							}

							let query = SimpleIDB.set("fb2Reader_book", JSON.stringify(this.book));
							query.catch((error) => {
								alert(error);
							});

							this.restoreProgress();
						} catch (err) {
							alert(this.lang("broken_book"));
							console.error(err);
							this.loading = false;
						}
					},
					getFullNane(node) {
						let fullName = [];
						fullName.push(this.nodeText(node.getElementsByTagName("first-name")[0]));
						fullName.push(this.nodeText(node.getElementsByTagName("middle-name")[0]));
						fullName.push(this.nodeText(node.getElementsByTagName("last-name")[0]));
						fullName.push(this.nodeText(node.getElementsByTagName("nick-name")[0]));
						return fullName.join(" ");
					},
					parseNode(node, i, deep = -2) {
						let output = "";

						if (node.nodeType == 1) {
							let that = this;
							let tags = {
								body: {
									start(node) {
										return "<div class='body'>";
									},
									end: "</div>",
								},
								annotation: {
									start(node) {
										return "<div class='annotation'>";
									},
									end: "</div>",
								},
								section: {
									start(node) {
										let id = node.getAttribute("id");
										return id != undefined ? `<section id='${id}'>` : "<section>";
									},
									end: "</section>",
								},
								p: {
									start(node) {
										if (node.textContent[0] == "—" || node.textContent[0] == "–") {
											return "<p class='mark dialogue'>";
										} else {
											return i == 0 ? "<p class='mark'>" : "<p>";
										}
									},
									end: "</p>",
								},
								title: {
									start(node) {
										let title = [];
										for (let p of node.getElementsByTagName("p")) {
											let t = "";
											for (let node of p.childNodes) {
												if (node.nodeType == 1 && node.nodeName != "a") {
													t += node.textContent;
												}
												if (node.nodeType == 3) {
													t += node.nodeValue;
												}
											}
											title.push(t);
										}
										if (i == 0) {
											that.book.chapters.push({
												deep: deep,
												title: title.join(" - "),
											});
										}
										return "<div class='title mark'>";
									},
									end: "</div>",
								},
								subtitle: {
									start(node) {
										return "<div class='subtitle mark'>";
									},
									end: "</div>",
								},
								"empty-line": {
									start(node) {
										return "<div class='line'>";
									},
									end: "</div>",
								},
								emphasis: {
									start(node) {
										return "<em>";
									},
									end: "</em>",
								},
								strong: {
									start(node) {
										return "<b>";
									},
									end: "</b>",
								},
								epigraph: {
									start(node) {
										return "<div class='epigraph mark'>";
									},
									end: "</div>",
								},
								cite: {
									start(node) {
										return "<blockquote class='mark'>";
									},
									end: "</blockquote>",
								},
								"text-author": {
									start(node) {
										return "<cite>";
									},
									end: "</cite>",
								},
								date: {
									start(node) {
										return "<date>";
									},
									end: "</date>",
								},
								poem: {
									start(node) {
										return "<div class='poem mark'>";
									},
									end: "</div>",
								},
								stanza: {
									start(node) {
										return "<div class='stanza mark'>";
									},
									end: "</div>",
								},
								v: {
									start(node) {
										return "<p class='mark'>";
									},
									end: "</p>",
								},
								image: {
									start(node) {
										let nextnode = node.nextSibling,
											cls = "";
										if (nextnode != null && nextnode.nodeType == 3) {
											cls = "float";
										}
										let id = node.getAttribute("l:href") || node.getAttribute("xlink:href");
										id = id.replace(/#/g, "");
										let binary = that.xml.getElementById(id);
										if (binary != null) {
											let type = binary.getAttribute("content-type");
											let base64 = binary.childNodes[0].nodeValue;
											return `<picture class="${cls}"><img src="data:${type};base64,${base64}"/></picture>`;
										} else {
											return "";
										}
									},
									end: "",
								},
								a: {
									start(node) {
										let href = node.getAttribute("l:href") || node.getAttribute("xlink:href");
										let text = node.textContent.replace(/[\{\}\[\]\(\)]/gi, "");
										return href != null && href[0] == "#" ? `<sup><a href='${href}'>${text}</a></sup>` : `<a href='${href}'>${text}</a>`;
									},
									end: "",
								},
								link: {
									start(node) {
										let href = node.getAttribute("l:href") || node.getAttribute("xlink:href");
										let text = node.textContent.replace(/[\{\}\[\]\(\)]/gi, "");
										return href != null && href[0] == "#" ? `<sup><a href='${href}'>${text}</a></sup>` : `<a href='${href}'>${text}</a>`;
									},
									end: "",
								},
							};

							if (tags[node.nodeName] != undefined) {
								output += tags[node.nodeName].start(node);

								for (let childNode of node.childNodes) {
									output += this.parseNode(childNode, i, deep + 1);
								}

								let end = tags[node.nodeName].end;
								output += end;
							} else {
								console.error(node.nodeName, "not node in parser");
							}
						} else if (node.nodeType == 3) {
							let text = node.nodeValue;

							if (node.parentNode.nodeName == "p" && node.parentNode.parentNode.name == "title") {
								//nothing
							} else {
								text = text.replace(/(\s)(\S+)$/gm, "&nbsp;$2");
								text = text.replace(/(\s\S{1,3})(\s)(\S+)/gm, "$1&nbsp;$3");
								text = text.replace(/(\d)(\s)(\S+)/gm, "$1&nbsp;$3");
								text = text.replace(/(\s)(—)/gm, "&nbsp;$2");
								text = text.replace(/(\S)(-)(\S)/gm, "$1&#x2060;$2&#x2060;$3");
							}
							output += text;
						}
						//console.log(output);
						return output;
					},
					theme(event) {
						let theme = event.target.value;
						if (theme == "custom") return;
						theme = theme.split("/");
						this.options.color = theme[0];
						this.options.background = theme[1];
						this.options.links = theme[2];
					},
					hashCode(s) {
						return s.split("").reduce(function (a, b) {
							a = (a << 5) - a + b.charCodeAt(0);
							return a & a;
						}, 0);
					},
					restoreProgress() {
						this.bookmarks = [];

						this.$nextTick(function () {
							if (localStorage["fb2Reader_scroll" + this.book.hash]) {
								let i = localStorage.getItem("fb2Reader_scroll" + this.book.hash);
								setTimeout(() => {
									let p = document.querySelectorAll(".page .mark");
									if (p.length > i) {
										p[i].scrollIntoView();
									}
								}, 100);
							}

							if (localStorage["fb2Reader_bookmarks" + this.book.hash]) {
								let bm = localStorage.getItem("fb2Reader_bookmarks" + this.book.hash);
								this.bookmarks = JSON.parse(bm);
								setTimeout(() => {
									let marks = document.querySelectorAll(".page p.mark");
									for (let bookmark of this.bookmarks) {
										marks[bookmark.number].classList.add("checked");
									}
								}, 100);
							}

							if (localStorage["fb2Reader_selections" + this.book.hash]) {
								let sl = localStorage.getItem("fb2Reader_selections" + this.book.hash);
								this.selections = JSON.parse(sl);
								this.addSelections();
							}
						});
					},
					nodeText(node) {
						if (node != null && node != undefined && node.childNodes.length > 0) {
							return node.childNodes[0].nodeValue;
						} else {
							return "";
						}
					},
					hideNotes() {
						if (this.showNotes) {
							this.showNotes = false;
							history.pushState(null, null, " ");
						}
					},
					lang(id) {
						translation = this.translations.find((z) => z.id == id);
						if (translation) {
							if (translation.hasOwnProperty(this.locale)) {
								return translation[this.locale];
							} else {
								return translation["en"];
							}
						}
					},
					scrollPercent() {
						this.percent = (((document.documentElement.scrollTop + document.body.scrollTop) / (document.documentElement.scrollHeight - document.documentElement.clientHeight)) * 100).toFixed(2);
					},
					goChapter(i) {
						let chapters = document.getElementsByClassName("title");
						chapters[i].scrollIntoView();
					},
					sizeChanged(e) {
						e.preventDefault();
						this.restoreProgress();
					},
					scroll() {
						this.hideNotes();
						this.scrollPercent();
						let marks = document.querySelectorAll(".page .mark");
						let wt = window.pageYOffset || document.documentElement.scrollTop;

						for (let mark of marks) {
							let bt = mark.offsetTop + mark.offsetHeight;

							if (bt >= wt) {
								this.scrollTop = Array.prototype.indexOf.call(marks, mark);
								break;
							}
						}

						localStorage.setItem("fb2Reader_scroll" + this.book.hash, this.scrollTop);

						let titles = document.querySelectorAll(".page .title"),
							number = 0;

						for (let title of titles) {
							let bt = title.offsetTop - 2 * this.options.fontSize;
							if (bt < wt) {
								number = Array.prototype.indexOf.call(titles, title);
							} else {
								break;
							}
						}

						this.currentChapter = number;
					},
					goBookmark(number) {
						let marks = document.querySelectorAll(".page p.mark");
						marks[number].scrollIntoView();
					},

					goSelection(hashCode) {
						let mark = document.querySelector("." + hashCode);
						if (mark) mark.scrollIntoView();
					},

					remBookmark(bookmark) {
						let marks = document.querySelectorAll(".page p.mark");
						marks[bookmark.number].classList.remove("checked");
						this.bookmarks = this.bookmarks.filter((z) => z != bookmark);
						localStorage.setItem("fb2Reader_bookmarks" + this.book.hash, JSON.stringify(this.bookmarks));
					},

					remSelection(selection) {
						event.stopPropagation();
						this.selections = this.selections.filter((z) => z != selection);
						localStorage.setItem("fb2Reader_selections" + this.book.hash, JSON.stringify(this.selections));

						if (this.selections.length > 0) {
							this.mark.unmark({
								done: () => {
									this.addSelections();
								},
							});
						} else {
							this.mark.unmark();
						}
					},

					addSelections() {
						for (let selection of this.selections) {
							this.mark.mark(selection.text, {
								caseSensitive: true,
								acrossElements: true,
								separateWordSearch: false,
								className: selection.hash,
							});
						}
					},

					close() {
						if (confirm(this.lang("remove_confirm"))) {
							localStorage.removeItem("fb2Reader_scroll" + this.book.hash);
							localStorage.removeItem("fb2Reader_bookmarks" + this.book.hash);
							let query = SimpleIDB.initialize();
							query = SimpleIDB.remove("fb2Reader_book");
							query
								.then((value) => {
									this.book = {
										title: "",
										author: "",
										cover: "",
										main: "",
										notes: "",
										hash: "",
										chapters: [],
										annotation: "",
									};
								})
								.catch((error) => {
									alert(error);
								});
						}
					},

					changeSelection() {
						let btns = document.querySelectorAll(".selectBtn");
						for (let btn of btns) {
							btn.remove();
						}

						let selection = window.getSelection();
						if (selection == null || selection.type != "Range") return;

						let text = selection.toString();
						text = text.replace(/(\r\n|\n|\r)/gm, "");

						if (text.length < 3) return;

						if (selection.focusNode == null) return;

						if (selection.focusNode == null) return;

						let p = null;
						if (selection.focusNode.nodeType == 3) {
							p = selection.focusNode.parentNode.closest("p.mark");
						} else {
							p = selection.focusNode.closest("p.mark");
						}

						if (p == null) return;

						let btn = document.createElement("button");
						btn.innerHTML = '<svg class="icon"><use xlink:href="#icon-highlight"></use></svg>';
						btn.classList.add("selectBtn");
						btn.setAttribute("title", this.lang("add_quote"));
						btn.addEventListener("click", () => {
							this.selections.push({
								hash: this.hash(text),
								text: text,
							});
							this.addSelections();
							localStorage.setItem("fb2Reader_selections" + this.book.hash, JSON.stringify(this.selections));
							window.getSelection().removeAllRanges();
							btn.remove();
						});
						p.appendChild(btn);
					},

					mouseUp(event) {
						let selection = window.getSelection();
						if (selection == null || selection.type != "Range") {
							let target = event.target;
							if (target.nodeName == "P" && target.classList.contains("mark")) {
								let marks = document.querySelectorAll(".page p.mark");
								let i = Array.prototype.indexOf.call(marks, target);
								let bookmark = this.bookmarks.find((z) => z.number == i);

								if (bookmark) {
									target.classList.remove("checked");
									this.bookmarks = this.bookmarks.filter((z) => z.number != i);
								} else {
									target.classList.add("checked");

									let parent = target.closest("section"),
										title = "";

									if (parent) {
										titleP = parent.querySelector(".title p:last-child");
										if (titleP) title = titleP.innerText;
									}

									this.bookmarks.push({
										number: i,
										title: title,
									});
								}

								this.bookmarks = this.bookmarks.sort((a, b) => {
									return a.number - b.number;
								});

								localStorage.setItem("fb2Reader_bookmarks" + this.book.hash, JSON.stringify(this.bookmarks));
							}
						}
					},

					saveQuotes(format) {
						let a = document.createElement("a");
						let content = this.selections.map((z) => z.text).join("\n\n");
						let fileName = this.book.title + "." + format;
						let file = new Blob([content], {
							type: "text/plain",
						});
						a.href = URL.createObjectURL(file);
						a.download = fileName;
						a.click();
						a.remove();
					},

					hash(text) {
						let hash = 0;
						for (let i = 0, len = text.length; i < len; i++) {
							let chr = text.charCodeAt(i);
							hash = (hash << 5) - hash + chr;
							hash |= 0;
						}
						return "m" + hash;
					},
					changeTheme() {
						if (this.options.dark) {
							document.querySelector('meta[name="theme-color"]').setAttribute("content", "#222");
						} else {
							document.querySelector('meta[name="theme-color"]').setAttribute("content", "#eee");
						}
					},
				},
				computed: {
					style() {
						return {
							fontSize: this.options.fontSize + "px",
							fontFamily: this.options.fontFamily,
							color: this.options.color,
							background: this.options.background,
							lineHeight: this.options.lineIndent,
						};
					},
					moreStyles() {
						let mergeSize = this.options.mergeDialogues ? -this.options.paraIndent : this.options.paraIndent;
						return `<style>
						a {
							color: ${this.options.links}
						}
						.page *::selection, .notes *::selection {
							background-color: ${this.options.color};
							color: ${this.options.background};
						}

						p {
							line-height: ${this.options.lineIndent};
						}

						blockquote {
							border-left: 0.4em solid ${this.options.color};
						}

						body::-webkit-scrollbar-track, .notes .scroll::-webkit-scrollbar-track {
							background: ${this.options.background};
						}

						body::-webkit-scrollbar-thumb, .notes .scroll::-webkit-scrollbar-thumb {
							background-color: ${this.options.color}; 
						}

						.notes {
							border-top: 1px solid ${this.options.color};
							background-color: ${this.options.background};
						}

						picture {
							background-color: ${this.options.figure};
						}

						section {
							text-align: ${this.options.textAlign}
						}

						.body section>p {
							text-indent: ${this.options.textIndent}em;
							margin: ${this.options.paraIndent}em 0;
						}

						p.dialogue +p.dialogue {
							margin-top: ${mergeSize}em;
						}

						mark {
							color: ${this.options.background};
							background-color: ${this.options.color};
						}
						</style>`;
					},
				},
			});
		</script>
	</body>
</html>
